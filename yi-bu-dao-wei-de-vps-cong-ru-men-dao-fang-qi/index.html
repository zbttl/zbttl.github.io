<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/bao32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/bao16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zbttl-github-io.vercel.app","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="包含网盘，下载工具，远程控制，端口穿透，科学上网工具，以及上面这些技术的环境基础搭建 环境">
<meta property="og:type" content="article">
<meta property="og:title" content="一步到位的 vps 从入门到放弃">
<meta property="og:url" content="https://zbttl-github-io.vercel.app/yi-bu-dao-wei-de-vps-cong-ru-men-dao-fang-qi/index.html">
<meta property="og:site_name" content="Bao&#39;s 备忘录">
<meta property="og:description" content="包含网盘，下载工具，远程控制，端口穿透，科学上网工具，以及上面这些技术的环境基础搭建 环境">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/w4xUEnd.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/ZXc7uEo.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/yX456qs.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/qYYUQUl.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/DDCb0Xz.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/cPWaH8W.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/3vV2Bp4.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/Dufepps.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/OJzLDBS.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/7l7REb9.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/mYBY1qN.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/WzbpA9R.png">
<meta property="article:published_time" content="2018-12-31T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-03T17:40:23.663Z">
<meta property="article:author" content="zbttl">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="rdp">
<meta property="article:tag" content="lnmp">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="rsshub">
<meta property="article:tag" content="filemanger">
<meta property="article:tag" content="aria2">
<meta property="article:tag" content="transmission">
<meta property="article:tag" content="bt">
<meta property="article:tag" content="vscoder">
<meta property="article:tag" content="emule">
<meta property="article:tag" content="vnc">
<meta property="article:tag" content="frp">
<meta property="article:tag" content="内网穿透">
<meta property="article:tag" content="cloudreve">
<meta property="article:tag" content="rclone">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/w4xUEnd.png">


<link rel="canonical" href="https://zbttl-github-io.vercel.app/yi-bu-dao-wei-de-vps-cong-ru-men-dao-fang-qi/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>一步到位的 vps 从入门到放弃 | Bao's 备忘录</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Bao's 备忘录" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Bao's 备忘录</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83"><span class="nav-number">1.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">2.</span> <span class="nav-text">基础环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-lnmp-%E4%B8%80%E9%94%AE%E5%8C%85%EF%BC%88%E5%92%8C%E5%AE%9D%E5%A1%94%E4%BA%8C%E9%80%89%E4%B8%80%EF%BC%89"><span class="nav-number">2.1.</span> <span class="nav-text">使用 lnmp 一键包（和宝塔二选一）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%EF%BC%88%E5%92%8C-lnmp-%E4%BA%8C%E9%80%89%E4%B8%80%EF%BC%89"><span class="nav-number">2.2.</span> <span class="nav-text">使用宝塔面板进行安装（和 lnmp 二选一）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-%E5%AE%89%E8%A3%85%E5%8F%8A%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">2.3.</span> <span class="nav-text">docker 安装及一些基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7"><span class="nav-number">2.4.</span> <span class="nav-text">新建一个用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-screen-%E5%92%8C-sudo"><span class="nav-number">2.5.</span> <span class="nav-text">安装 screen 和 sudo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%90%84%E9%A1%B9%E4%BE%9D%E8%B5%96"><span class="nav-number">2.6.</span> <span class="nav-text">其他各项依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.7.</span> <span class="nav-text">目录设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lnmp-%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">lnmp 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx"><span class="nav-number">3.1.</span> <span class="nav-text">nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.1.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%AB%99%E7%82%B9"><span class="nav-number">3.1.2.</span> <span class="nav-text">配置站点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E6%89%8B%E5%B7%A5%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.3.</span> <span class="nav-text">基本的手工配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E5%90%84%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.4.</span> <span class="nav-text">关于各程序的详细配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E8%AF%81%E4%B9%A6%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.5.</span> <span class="nav-text">关于证书的配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E6%95%88%E6%9E%9C%E6%B5%8B%E8%AF%95"><span class="nav-number">3.1.6.</span> <span class="nav-text">关于效果测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql"><span class="nav-number">3.2.</span> <span class="nav-text">mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95-mysql"><span class="nav-number">3.2.1.</span> <span class="nav-text">登录 mysql</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="nav-number">3.2.2.</span> <span class="nav-text">新建用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E5%A4%96%E7%BD%91-ip-%E9%80%9A%E8%BF%87%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E7%99%BB%E5%BD%95"><span class="nav-number">3.2.3.</span> <span class="nav-text">允许外网 ip 通过其他工具登录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%84%E5%8A%9F%E8%83%BD%E5%AE%89%E8%A3%85"><span class="nav-number">4.</span> <span class="nav-text">各功能安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-%E7%B1%BB"><span class="nav-number">4.1.</span> <span class="nav-text">docker 类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BE%E5%BA%A6%E4%B8%80%E9%94%AE%E7%AD%BE%E5%88%B0"><span class="nav-number">4.1.1.</span> <span class="nav-text">百度一键签到</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rsshub"><span class="nav-number">4.1.2.</span> <span class="nav-text">rsshub</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">注意事项</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filemanager%EF%BC%88docker%EF%BC%89"><span class="nav-number">4.1.3.</span> <span class="nav-text">filemanager（docker）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#aria2-docker"><span class="nav-number">4.1.4.</span> <span class="nav-text">aria2 docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#amule%EF%BC%88docker%EF%BC%89"><span class="nav-number">4.1.5.</span> <span class="nav-text">amule（docker）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mldonkey%EF%BC%88docker%EF%BC%89"><span class="nav-number">4.1.6.</span> <span class="nav-text">mldonkey（docker）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vscoder"><span class="nav-number">4.1.7.</span> <span class="nav-text">vscoder</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%BB%E7%BA%BF%E4%B8%8B%E8%BD%BD%E7%B1%BB"><span class="nav-number">4.2.</span> <span class="nav-text">离线下载类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#aria2%EF%BC%8819-11-18-%E6%9B%B4%E6%96%B0%EF%BC%89"><span class="nav-number">4.2.1.</span> <span class="nav-text">aria2（19.11.18 更新）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">参考资料</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%92%8C%E4%B8%8B%E8%BD%BD"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">环境和下载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%BA%90%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="nav-number">4.2.1.3.</span> <span class="nav-text">编译源文件修改</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%92%8C%E5%AE%89%E8%A3%85"><span class="nav-number">4.2.1.4.</span> <span class="nav-text">编译和安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%85%8D%E7%BD%AE%E5%BB%BA%E7%AB%8B"><span class="nav-number">4.2.1.5.</span> <span class="nav-text">下载配置建立</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%89%8D%E7%AB%AF"><span class="nav-number">4.2.1.6.</span> <span class="nav-text">配置前端</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#transmission%EF%BC%88%E9%80%89%E7%94%A8%EF%BC%89"><span class="nav-number">4.2.2.</span> <span class="nav-text">transmission（选用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Simple-Torrent%EF%BC%88%E9%80%89%E5%81%9A%EF%BC%89"><span class="nav-number">4.2.3.</span> <span class="nav-text">Simple Torrent（选做）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filebrowser%EF%BC%88%E6%99%AE%E9%80%9A%EF%BC%89"><span class="nav-number">4.2.4.</span> <span class="nav-text">filebrowser（普通）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#amule%EF%BC%88%E9%80%89%E7%94%A8%EF%BC%89"><span class="nav-number">4.2.5.</span> <span class="nav-text">amule（选用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mldonkey%EF%BC%88%E9%80%89%E7%94%A8%EF%BC%89"><span class="nav-number">4.2.6.</span> <span class="nav-text">mldonkey（选用）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%B1%BB"><span class="nav-number">4.3.</span> <span class="nav-text">远程控制类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#vnc"><span class="nav-number">4.3.1.</span> <span class="nav-text">vnc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tiny-remote-desktops-%EF%BC%8820-12-23-%E6%9B%B4%E6%96%B0%EF%BC%89"><span class="nav-number">4.3.2.</span> <span class="nav-text">tiny-remote-desktops （20.12.23 更新）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="nav-number">4.4.</span> <span class="nav-text">内网穿透</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#frp"><span class="nav-number">4.4.1.</span> <span class="nav-text">frp</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88windows%EF%BC%89"><span class="nav-number">4.4.1.2.</span> <span class="nav-text">客户端（windows）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E8%BF%90%E8%A1%8C"><span class="nav-number">4.4.1.3.</span> <span class="nav-text">快速运行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%87%AA%E5%90%AF"><span class="nav-number">4.4.1.4.</span> <span class="nav-text">配置自启</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stcp-%E5%92%8C-xtcp"><span class="nav-number">4.4.1.5.</span> <span class="nav-text">stcp 和 xtcp</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nps"><span class="nav-number">4.4.2.</span> <span class="nav-text">nps</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF-1"><span class="nav-number">4.4.2.1.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">4.4.2.2.</span> <span class="nav-text">客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%9B%98%E7%B1%BB"><span class="nav-number">4.5.</span> <span class="nav-text">网盘类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cloudreve%EF%BC%88%E9%80%89%E5%81%9A%EF%BC%89"><span class="nav-number">4.5.1.</span> <span class="nav-text">cloudreve（选做）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rclone"><span class="nav-number">4.5.2.</span> <span class="nav-text">rclone</span></a></li></ol></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zbttl" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">zbttl</p>
  <div class="site-description" itemprop="description">玩点好玩的</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">110</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zbttl" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zbttl" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zbttls@gmail.com" title="E-Mail → mailto:zbttls@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zbttl-github-io.vercel.app/yi-bu-dao-wei-de-vps-cong-ru-men-dao-fang-qi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="zbttl">
      <meta itemprop="description" content="玩点好玩的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bao's 备忘录">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          一步到位的 vps 从入门到放弃
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-01T00:00:00+08:00">2019-01-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-04 01:40:23" itemprop="dateModified" datetime="2021-07-04T01:40:23+08:00">2021-07-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Downloadtools/" itemprop="url" rel="index"><span itemprop="name">Downloadtools</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>48k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:28</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>包含网盘，下载工具，远程控制，端口穿透，科学上网工具，以及上面这些技术的环境基础搭建</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>debian 9,512m/1024m 内存 vps</p>
<p>下文默认在 root 下执行</p>
<h2 id="基础环境搭建"><a href="#基础环境搭建" class="headerlink" title="基础环境搭建"></a>基础环境搭建</h2><p>基础环境我选择 lnmp （或者叫做 lemp）</p>
<p>安装前务必卸载 nginx，php 和 mysql（通过 apt remove 卸载），因为所使用的目录不同（apt 安装使用的目录是 /etc，而 lnmp 会安装到 /usr/local 下）</p>
<p>另外如果遇到安装 lnmp 后某些组件无法自启，请使用 systemctl unmask 和 enable 命令进行修复</p>
<p>比如我就是 nginx 出现了问题：</p>
<ol>
<li><p><code>service status nginx</code>，检测出结果为 unmask </p>
<p> <img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/w4xUEnd.png"></p>
<p> 但使用 <code>lnmp nginx start</code> 可以启动</p>
</li>
<li><p><code>systemctl unmask nginx.service</code> 后 <code>systemctl enable nginx</code>，重启发现 nginx 正常启动</p>
<p> <img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/ZXc7uEo.png"></p>
</li>
</ol>
<h3 id="使用-lnmp-一键包（和宝塔二选一）"><a href="#使用-lnmp-一键包（和宝塔二选一）" class="headerlink" title="使用 lnmp 一键包（和宝塔二选一）"></a>使用 lnmp 一键包（和宝塔二选一）</h3><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://lnmp.org/install.html">lnmp 一键安装包.org</a></p>
<p>因为我的机器是 512m 的，所以推荐安装 lnmp 1.6 测试版，因为该版本自动分配了 1g 的虚拟内存，避免编译时因为内存太小而编译失败</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://soft.vpser.net/lnmp/lnmp1.6beta.tar.gz -cO lnmp1.6beta.tar.gz &amp;&amp; tar zxf lnmp1.6beta.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<p>运行完后得到 lnmp1.6 文件夹，修改其中的 lnmp.conf ，将<code>Enable_PHP_Fileinfo</code>这项改为<code>'y'</code>，除非接下来你不需要安装<a href="#Cloudreve">Cloudreve</a>。如果安装前这步忘记做了，可以安装后通过<a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.laozuo.org/11801.html">该文</a>所写补装 fileinfo。</p>
<p>之后，安装 lnmp，需要大概 40 分钟</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd lnmp1.6 &amp;&amp; ./install.sh lnmp</span><br></pre></td></tr></tbody></table></figure>
<p>中途会叫你输入 mysql 相关的管理员密码，自己设定并记住这个密码，后面要用到。其他选项保持默认即可。</p>
<p>安装完后，输入 <code>which nginx</code>和<code>which lnmp nginx</code>，查看前者显示的路径里面是否在后者显示的路径中有包含。建议对 mysql 和 php 也做相似的操作。如果都有的话证明安装成功。</p>
<p>然后运行<code>php -m</code>，查看其中时候是否有 fileinfo 和 gd 两个扩展。</p>
<p>全部检查完毕，证明 lnmp 部署成功。</p>
<h3 id="使用宝塔面板进行安装（和-lnmp-二选一）"><a href="#使用宝塔面板进行安装（和-lnmp-二选一）" class="headerlink" title="使用宝塔面板进行安装（和 lnmp 二选一）"></a>使用宝塔面板进行安装（和 lnmp 二选一）</h3><p>宝塔面板操作更简单，但是所需内存也更大。</p>
<p>安装：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh &amp;&amp; bash install.sh</span><br></pre></td></tr></tbody></table></figure>
<p>安装后会显示面板地址和账户密码，马上输入面板地址和账户密码并更改密码以及放行端口（特别是对于改过 ssh 端口的），如果能进入 ssh 却忘记了密码的，可以通过<code>bt指令</code>来更改密码。另外，一开始是用<code>ip地址:端口号/目录</code>给定面板地址，有的时候绑上域名后反而打不开面板，可能需要改端口号解决，同样是使用<code>bt</code>指令。</p>
<p>因为宝塔面板在 debian 使用的是 ufw 防火墙，若是觉得宝塔面板的防火墙碍事，可以通过命令关闭</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable ufw.service</span><br></pre></td></tr></tbody></table></figure>
<p>登录面板后通过提示安装 lnmp+phpadmin（php 可视化管理工具），安装完后再插件页面选中安装的 php，插件管理处添加 fileinfo 即可。</p>
<h3 id="docker-安装及一些基本操作"><a href="#docker-安装及一些基本操作" class="headerlink" title="docker 安装及一些基本操作"></a>docker 安装及一些基本操作</h3><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="http://get.daocloud.io/#install-docker">Docker 极速下载</a></p>
<ol>
<li><p>安装 docker:</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.daocloud.io/docker | sh</span><br></pre></td></tr></tbody></table></figure>
<p> 安装 docker-compose</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/1.23.2/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>常用命令（此处的 xxx 可以是 id 也可以是 name）</p>
<table>
<thead>
<tr>
<th>用途</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>查看系统内现存的镜像</td>
<td><code>docker image ls</code></td>
</tr>
<tr>
<td>删除系统内现存镜像</td>
<td><code>docker rmi xxx</code></td>
</tr>
<tr>
<td>查看容器</td>
<td><code>docker ps -a</code></td>
</tr>
<tr>
<td>停止容器</td>
<td><code>docker stop xxx</code></td>
</tr>
<tr>
<td>删除容器</td>
<td><code>docker rm xxx</code></td>
</tr>
<tr>
<td>添加自启（container 正在运行时）</td>
<td><code>docker update --restart=always xxx</code></td>
</tr>
<tr>
<td>docker-compose 文件加载（后台运行带 -d 参数）</td>
<td><code>docker-compose up -d</code></td>
</tr>
<tr>
<td>docker-compose 文件卸载</td>
<td><code>docker-compose down</code></td>
</tr>
<tr>
<td>查看容器错误信息</td>
<td><code>docker logs xxx</code></td>
</tr>
</tbody></table>
<p> 这里说一下 docker-compose 的原理：将 docker 模块的参数写在一个文件中，运行加载命令就会把模块和参数一起配置好运行，如果发现其中有的模块镜像还没有被拉取会先行拉取，拉去过就会直接部署。如果要对其中已经部署成容器的模块进行修改，不能直接进入容器修改，而是需要使用相同的文件利用卸载命令进行卸载后再修改文件里面的参数然后再重新加载。</p>
<p> 所以：</p>
<ul>
<li>如果要运行两个不同的 docker-compose 的话，建议下载到不同的文件夹中或者使用不同的便于分辨的名字；</li>
<li>修改前一定记得用未修改的原文件进行卸载！如果使用修改后的文件不卸载直接加载可能会遭遇莫名其妙不好处理的错误。</li>
</ul>
</li>
<li><p>进入容器中进行操作</p>
<p> 参考文章:<a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/zzy1078689276/article/details/77389177/">docker容器中文件的上传与下载</a></p>
<p> 最常用的方法是使用 docker 内的 bash 程序，这时需要用到 docker 的 exec 命令</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it xxxx /bin/sh</span><br></pre></td></tr></tbody></table></figure>
<p> 这里的和下面的 xxxx 需要填写容器的 id（可通过 ps 命令查询）</p>
<p> <code>/bin/sh</code>有可能在别的路径或者是别的 bash，需要根据不同程序自己修改，但大部分是这个，不过也可能没有。。。那就没辙了</p>
<p> 此时如果需要复制本机的文件到 docker 或者反过来操作，可以通过 docker cp 指令</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp xxxx:/root/test.txt /root/</span><br></pre></td></tr></tbody></table></figure>
<p> 冒号后面的是 docker 内路径，另一个就是本机路径。</p>
</li>
</ol>
<h3 id="新建一个用户"><a href="#新建一个用户" class="headerlink" title="新建一个用户"></a>新建一个用户</h3><p>后面某些应用（caddy，transmission）需要非 root 下运行，如果不自己新建用户的话，他们默认的用户会冲突，表现在两者共有的文件夹在其中一个应用中无法进行某些操作（如删除）。</p>
<p>新建方法</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -d [用户目录] -m [用户名]</span><br><span class="line"># 然后记得改密码</span><br><span class="line">passwd [用户名]</span><br></pre></td></tr></tbody></table></figure>

<p>下面教程以我的用户名 zbttl 为例。</p>
<h3 id="安装-screen-和-sudo"><a href="#安装-screen-和-sudo" class="headerlink" title="安装 screen 和 sudo"></a>安装 screen 和 sudo</h3><p><code>apt install screen sudo -y</code></p>
<p>screen 常用命令（xxx 为自己起的名字）<br>| 作用                 | 命令                  |<br>| ——————– | ——————— |<br>| 打开一个 screen 窗口 | screen -S xxx         |<br>| 查看已经打开的窗口   | screen -ls            |<br>| 进入正在运行的窗口   | screen -r xxx         |<br>| 强退一个窗口         | screen -X -S xxx quit |</p>
<h3 id="其他各项依赖"><a href="#其他各项依赖" class="headerlink" title="其他各项依赖"></a>其他各项依赖</h3><ol>
<li><p>系统更新</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get dist-upgrade -y</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>gcc 编译相关</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y libcurl4-openssl-dev libevent-dev ca-certificates libssl-dev pkg-config build-essential intltool libgcrypt-dev libssl-dev libxml2-dev gcc</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>进程守护 supervisor</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install supervisor -y</span><br></pre></td></tr></tbody></table></figure>

<p> 注意，如果往后发现下面通过 supervisor 设定的自启不正常了，可以检查一下<code>/etc/supervisor/supervisord.conf</code>，里面应该有这么一行</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">files = /etc/supervisor/conf.d/*</span><br></pre></td></tr></tbody></table></figure>

<p> 这行东西如果后面跟了什么后缀或者没写到文件里面都有可能造成异常，通过<code>supervisorctl</code>也可以获知哪些程序自启了哪些没有或者没正常自启。</p>
</li>
<li><p>python</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install python python-pip -y</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>买一个域名，将 vps 指向域名，可以多做几个三级域名以免去 nginx location 项的编写。</p>
</li>
<li><p><del>修改时间</del></p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tzselect</span><br></pre></td></tr></tbody></table></figure>

<p> <del>按照提示选择国家与地区，最后会得到一行代码，运行后 vps 时间就会校准为你当前所在地区的时间。如果你在大陆的话，一般直接运行以下代码：</del></p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TZ='Asia/Shanghai'; export TZ</span><br></pre></td></tr></tbody></table></figure>

<p> <del>确认一下</del></p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date -R</span><br></pre></td></tr></tbody></table></figure>

<p> 划掉的这个方法，是临时改时间的方法；要永久生效的话需要将 <code>TZ='Asia/Shanghai'; export TZ</code> 写入 profile 文件中，而且还不知道是否在系统中全局生效（可能只在终端中生效？）</p>
<p> 好处是泛用性比较好。</p>
<p> 适用于 debian，永久更改时区的办法，参考：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.myfreax.com/how-to-set-or-change-timezone-on-debian-9/">如何在Debian 9上设置或更改时区</a></p>
<p> 查看时区代码，找到其中你所在时区对应的时区代码</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl list-timezones</span><br></pre></td></tr></tbody></table></figure>

<p> 修改，和上面一样，人在大陆，这么输</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></tbody></table></figure>

<p> 确认</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>更改语言</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg-reconfigure locales</span><br></pre></td></tr></tbody></table></figure>

<p> 在弹出的窗口一路 page down 找到<code>zh_CN.UTF-8 UTF-8</code>，按下空格勾选，回车后选择默认语言，同样选到<code>zh_CN.UTF-8</code>，重启即可。</p>
</li>
</ol>
<h3 id="目录设计"><a href="#目录设计" class="headerlink" title="目录设计"></a>目录设计</h3><p>web：<code>/home/web</code></p>
<p>证书：<code>/home/ssl</code></p>
<p>用户目录：<code>/home/zbttl</code></p>
<p>下载目录: <code>/home/zbttl/download</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/web /home/ssl</span><br><span class="line">sudo chown zbttl /home/web /home/ssl</span><br><span class="line">su - zbttl</span><br><span class="line">mkdir /home/zbttl/download</span><br><span class="line">sudo chmod 0770 /home/ssl</span><br></pre></td></tr></tbody></table></figure>



<h2 id="lnmp-配置"><a href="#lnmp-配置" class="headerlink" title="lnmp 配置"></a>lnmp 配置</h2><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>apt install 安装的 nginx 配置文件位于 <code>/etc/nginx</code> 处，而 lnmp 一键包安装则位于 <code>/usr/local/nginx/conf</code> 内，宝塔的是<code>/www/server/nginx/conf</code> 内。如果使用后两者的界面来配置站点的话，它们还会把配置文件里面的站点扔到 conf 目录的 vhost 文件夹里面。虽然后两者都配有界面可以安装修改站点，要纠错或者是改点内容的话还是手工到目录里面改比较好。</p>
<h4 id="配置站点"><a href="#配置站点" class="headerlink" title="配置站点"></a>配置站点</h4><ul>
<li><p>apt 安装的 nginx。默认的 nginx 会读取 <code>/etc/nginx/modules-enabled/</code> 里面的 conf 文件，所以把下面提到的手工配置的 <code>server</code> 代码块放到自建的文件里就好。也可以仿照 lnmp 的，在 <code>nginx.conf</code> 的 <code>http</code> 代码块内新增一行</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include vhosts/*.conf;</span><br></pre></td></tr></tbody></table></figure>

<p>然后也在 <code>vhosts</code> 文件夹里面放文件（server 代码块）。</p>
</li>
<li><p>lnmp 一键包：<code>lnmp vhost add</code>，第一个问题输入自己的三级域名，第二个问题直接回车，第三个问题输入网站所在目录，第四个问题根据所要配置的站点而决定（比如 cloudreve 就要求 rewrite 到 thinkphp），第五个问题决定你的站点能不能访问到 phpinfo（可以查看当前 php 状态和所安装的组件的页面），第六个问题问你写不写日志，第七个问题要不要创建同名数据库（实际上大多数情况都是自己创建数据库，选 n 或者直接回车就好了），第七个问题要不要做证书（我选择手工做，待会会讲到）。之后回车搞定。</p>
<p>如果要查看已经制作了几个站点，输入<code>lnmp vhost list</code>。</p>
<p>如果想要删除站点，输入<code>lnmp vhost del</code>。</p>
</li>
<li><p>宝塔面板：这个就方便多了，点进网站，添加站点，如果想上面那样一路 n 下来的话，只需要填两个地方就行了</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/yX456qs.png"></p>
</li>
</ul>
<p>以下假设我配置了一个 708hentai.baobaobao.xxx 的站点。</p>
<h4 id="基本的手工配置"><a href="#基本的手工配置" class="headerlink" title="基本的手工配置"></a>基本的手工配置</h4><p>进入 <code>vhost</code> 目录，打开站点 conf 文件，大概会是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/qYYUQUl.png"></p>
<p>listen：nginx 所在的端口，如果填写 80 证明是 http 端口，443 是 https 端口，这两种情况下地址后面无需附上端口号。</p>
<p>server_name：三级域名</p>
<p>index：主页</p>
<p>root：站点所在目录</p>
<p>include：包括的扩展性配置文件，这里的两个 include 后面指的就刚刚的 rewrite 和 phpinfo 是否启用的配置。</p>
<p>location：跟在网址和端口后面「/xxxx」的，相当于站点目录的相关配置，一般「/」这个代表默认目录。这里的四个 location 建议删掉，否则容易出问题。</p>
<h4 id="关于各程序的详细配置"><a href="#关于各程序的详细配置" class="headerlink" title="关于各程序的详细配置"></a>关于各程序的详细配置</h4><h4 id="关于证书的配置"><a href="#关于证书的配置" class="headerlink" title="关于证书的配置"></a><span id="cert">关于证书的配置</span></h4><p>参考资料：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jianshu.com/p/b6b172f69c14">acme.sh + Let’s Encrypt + nginx 配置通配符HTTPS</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.imydl.tech/lnmp/394.html">Let’s Encrypt通配符证书申请办法，实测有效</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.sooele.com/1684.html">Linux 下使用 acme.sh 配置 Let’s Encrypt 免费 SSL 证书 + 通配符证书</a></li>
</ul>
<p>因为是同一个二级域名下衍生的大量三级域名，所以建议申请泛域名证书。除非是 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md">api网站</a> 中写明支持可以获得 api key 的域名商，否则，请把域名的 dns 解析托管到 cloudfare 上。下文以域名已托管到 cloudfare 为例。</p>
<ol>
<li><p>打开 CF 的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://dash.cloudflare.com/profile">api 网址</a>，找到最底部的 Global API Key，点击 view，记下字符串。</p>
</li>
<li><p>在 ssh 处输入下列代码，key 后面的 xxx 输入刚刚记下的字符串，email 后面的 xxx 则输入你的 cf 登录邮箱。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export CF_Key="xxxxxx"</span><br><span class="line">export CF_Email="xxxxxx"</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>下载，安装，申请证书，注意里面一个是二级域名一个是泛域名，两个缺一不可（<code>-k ec-256</code> 可选，ecc 证书兼容性稍差无法兼容安卓 2.2 等超旧版本，但速度快于普通 rsa 证书）</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl  https://get.acme.sh | sh</span><br><span class="line">source ~/.bashrc</span><br><span class="line">acme.sh --issue --dns dns_cf -d example.com -d *.example.com -k ec-256</span><br></pre></td></tr></tbody></table></figure>

<p>例如我的域名是 baobaobao.xxx，那么就应该这么写</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --issue --dns dns_cf -d baobaobao.xxx -d *.baobaobao.xxx -k ec-256</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>安装证书，<code>keypath</code> 和 <code>fullchainpath</code> 后面的路径和名字自定，建议放到同一目录，可以放到 <code>/home</code> 或者 <code>/etc</code>，后续还要再给读写权限。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --installcert -d baobaobao.xxx --keypath /home/ssl/baobaobao.key --fullchainpath /home/ssl/baobaobao.crt --reloadcmd "nginx -s reload" --ecc</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>生成 <code>dhparam.pem</code>文件，生成目录跟上面两个文件的目录保持一致（仅 nginx 使用，caddy 跳过该步骤）</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl dhparam -out /home/ssl/dhparam.pem 2048</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>填入 nginx 中即可。</p>
</li>
<li><p>可通过 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.ssllabs.com/ssltest/index.html">Qualys SSL Labs’s SSL Server Test</a> 或者 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.httpsecurityreport.com/">HTTP Security Report</a> 进行测试。拿到 a 即可，如果想要拿到 a+，需要开启 hsts。</p>
</li>
<li><p>acme 的其他命令</p>
<p>查看注册了哪些域名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh list</span><br></pre></td></tr></tbody></table></figure>

<p>移除域名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh remove xxx [--ecc]</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h4 id="关于效果测试"><a href="#关于效果测试" class="headerlink" title="关于效果测试"></a>关于效果测试</h4><p>https 因为有 hsts 的特性，一旦输入过 https 的网址，浏览器就会自动对相同网址的 host 部分进行不全，此时 web 服务器协议就算回到 http，在相同浏览器上因为补全为 https 的原因，会打不开。所以建议测试的时候用浏览器的隐身模式，不会记录下 hsts。如果不慎受到 hsts 影响，可以通过<code>chrome://net-internals/#hsts</code> 进行清除。</p>
<p>另外，有时候关掉服务器后页面仍然能加载，是因为缓存的原因，可以通过右键刷新按钮，选择硬性加载来强制刷新缓存。或者一开始就用隐身模式进行调试。</p>
<p>另外，如果 nginx 开不起来，也可能是配置文件有问题，可通过</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></tbody></table></figure>

<p>检测配置文件。</p>
<p>另外也可以在 <code>/var/log/nginx</code> 中检视日志文件。（不过 nginx 的日志做转发的时候很不直观）</p>
<h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><p>在宝塔面板上添加删除 mysql 用户很方便，gui 一把梭，不再赘述。只谈谈 lnmp 一键包的（当然宝塔也适用使用以下步骤）。另外宝塔编辑表也可以用自带的 phpadmin 而不需要在自己的电脑上安装 navicat，或者，在相应数据库内设置访问权限为所有人，才能用 navicat  登陆。</p>
<h4 id="登录-mysql"><a href="#登录-mysql" class="headerlink" title="登录 mysql"></a>登录 mysql</h4><p>输入<code>mysql -p</code>，再输入你 lnmp 安装时创建的密码即可登录。</p>
<p>不过推荐使用 mysql 自动补全工具来登录</p>
<p>先安装</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install tldr mycli</span><br></pre></td></tr></tbody></table></figure>

<p>然后敲入 mycli 输入密码即可登录。</p>
<h4 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h4><p>因为一直使用 root 用户去创建其他服务所用的数据库有一定危险性，所以先去创建一个用户。先查看默认有什么数据库<code>show databases;</code>，应该会有名为<code>mysql</code>的默认数据库。进入<code>use mysql;</code>，查看目前的账户情况：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select Host,user,Password,plugin from user;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/DDCb0Xz.png"></p>
<p>host 是允许登录的主机，user 代表用户，password 表示密码（这里显示的密码是通过加密的），plugin 只要是空的就不用管。</p>
<p>然后我们新建一个名为 zbttl 的用户，xxxx处填入密码：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER 'zbttl'@'%' IDENTIFIED BY 'xxxx';</span><br></pre></td></tr></tbody></table></figure>

<p>给予权限</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO 'zbttl'@'%';</span><br></pre></td></tr></tbody></table></figure>

<p><code>ALL PRIVILEGES</code>表示操作（select，update）这些，on 后面表示数据库，这里也可以自己自定义，多个操作用逗号隔开，我选择全给。</p>
<p>然后再次查看目前的帐号情况，发现用户已经被添加进去了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/cPWaH8W.png"></p>
<p>然后我们需要刷新一下权限表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush privileges;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="允许外网-ip-通过其他工具登录"><a href="#允许外网-ip-通过其他工具登录" class="headerlink" title="允许外网 ip 通过其他工具登录"></a>允许外网 ip 通过其他工具登录</h4><p>想要从主机上用 navicat 登录 mysql，发现无法登陆？</p>
<p>刚刚建立的用户，localhost 一栏写的是 %，代表可以从任何地址进行访问。不过因为防火墙没有开，所以仍然不能进行访问，需要配置一下路由表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 3306 -j ACCEPT</span><br></pre></td></tr></tbody></table></figure>

<p>而 root 用户因为没有配置 % 这个地址，所以只能从 ssh 内进行访问。如果也想用 navicat 访问，需要添加 % 这一行，在上一步给予权限的位置加上这一步（xxxx 同样是密码）</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'xxxx' WITH GRANT OPTION;</span><br></pre></td></tr></tbody></table></figure>

<p>即可。</p>
<h2 id="各功能安装"><a href="#各功能安装" class="headerlink" title="各功能安装"></a>各功能安装</h2><h3 id="docker-类"><a href="#docker-类" class="headerlink" title="docker 类"></a>docker 类</h3><h4 id="百度一键签到"><a href="#百度一键签到" class="headerlink" title="百度一键签到"></a>百度一键签到</h4><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/MoeNetwork/Tieba-Cloud-Sign">MoeNetwork/Tieba-Cloud-Sign</a></p>
<ol>
<li><p>下载 compose 文件</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/docker-compose/tieba/&amp;&amp;cd /root/docker-compose/tieba/</span><br><span class="line">wget https://raw.githubusercontent.com/zsnmwy/Tieba-Cloud-Sign/master/docker-compose.yml</span><br></pre></td></tr></tbody></table></figure>
<p> 然后打开文件，修改 <code>CSRF:"true"</code>为 false<br>“80:8080”中的 80 最好修改成其他数字，比如 90，避免和 nginx 的 http 端口冲突</p>
<p> web 里的 <code>DB_USER</code> 和 <code>DB_NAME</code> 可以改，和底下 db 的 <code>MYSQL_DATABASE</code> 和 <code>MYSQL_ROOT_PASSWORD</code> 对的上就可以。</p>
</li>
<li><p>部署<code>docker-compose up -d</code></p>
</li>
<li><p>在浏览器输入 <code>ip:端口号</code>，比如我 vps ip 是 45.27.100.100 那么这里就是 <code>45.27.100.100:90</code></p>
</li>
<li><p>根据提示前往安装，不可写主机处选否，自动获得数据库配置信息填是，然后填入名字，邮箱和密码（登录的时候要用），确定后即可进入登录界面。</p>
</li>
<li><p>获取 BDUSS（直接帐号登录的功能基本是废的），方法页面里有说明，结束。</p>
</li>
<li><p>记得添加自启。可以通过 docker update 命令。也可以通过在 compose 文件中模块下写入</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restart: always</span><br></pre></td></tr></tbody></table></figure>

<p> 一共就两个模块，都写进去就好了。</p>
</li>
<li><p><strong>（20.11.12 更新）</strong> 用 tx 轻量服务器搭，出现 2002 错误。有一些解决方法有待参考：</p>
<ul>
<li><p>安装时 <code>dpkg-reconfigure locales</code> 改回 <code>en_US.UTF-8</code></p>
</li>
<li><p>运行 <code>docker-compose down</code> 后删除 <code>/opt/tieba</code> 再重装。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -r /opt/tieba</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>官方教程中提到可以改 <code>mysql_autoload.php</code>，这个文件在 <code>tieba_web_1</code> 容器中的 <code>/srv/www/lib/</code> 文件夹内。我改了没用，因为问题也不是在那个地方。</p>
<h4 id="rsshub"><a href="#rsshub" class="headerlink" title="rsshub"></a>rsshub</h4></li>
</ul>
</li>
</ol>
<p>参考文章：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.rsshub.app/install/#tian-jia-pei-zhi">docker-compose 部署</a></li>
</ul>
<p>下载 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/DIYgod/RSSHub/blob/master/docker-compose.yml">docker-compose.yml</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/docker-compose/rsshub&amp;&amp;<span class="built_in">cd</span> /root/docker-compose/rsshub</span><br><span class="line">wget https://raw.githubusercontent.com/DIYgod/RSSHub/master/docker-compose.yml</span><br></pre></td></tr></tbody></table></figure>

<p>创建 volume 持久化 Redis 缓存</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create redis-data</span><br></pre></td></tr></tbody></table></figure>

<p>启动</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></tbody></table></figure>

<p>然后就能通过 url <code>ip:1200/参数</code> 进行订阅了。参数看这里：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.rsshub.app/social-media.html">社交媒体</a></p>
<p>当然你也可以直接白嫖默认的域名参数来用，我 pixiv 就是这么订阅的，否则要翻墙（</p>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol>
<li><p>如果遭遇 rss 订阅错误，可以将完整 url 放入浏览器中，会弹出相应的错误提示。</p>
</li>
<li><p>如果墙内 vps 要订阅支持 pixiv，需要在 compose 文件 <code>service.rsshub</code> 的 <code>enviroment</code> 下指明自己的 pixiv 帐号密码（即使只是为了订阅日榜周榜）：</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PIXIV_USERNAME:</span> <span class="string">'xxx'</span></span><br><span class="line"><span class="attr">PIXIV_PASSWORD:</span> <span class="string">'xxx'</span></span><br></pre></td></tr></tbody></table></figure>

<p>同时还要写下代理配置，同样是写在<code>service.rsshub</code> 的 <code>enviroment</code> 下：</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PROXY_PROTOCOL:</span> <span class="string">'socks'</span></span><br><span class="line"><span class="attr">PROXY_HOST:</span> <span class="string">'127.0.0.1'</span></span><br><span class="line"><span class="attr">PROXY_PORT:</span> <span class="number">3080</span></span><br></pre></td></tr></tbody></table></figure>

<p>不过，因为 docker 实际上和本机的端口是不互通的，所以想要连上本机的代理，无非两种方法：</p>
<ol>
<li><p>本机代理监听的地址从 localhost（127.0.0.1）改为 0.0.0.0（不推荐，没上密码就可能被人盗用）</p>
</li>
<li><p>该 docker 模块使用 host 模式启动（<a target="_blank" rel="external nofollow noopener noreferrer" href="https://stackoverflow.com/questions/35960452/docker-compose-running-containers-in-nethost">参考文章</a>）。在<code>service.rsshub</code>下写入：</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network_mode:</span> <span class="string">"host"</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
</li>
<li><p>不正确的卸载 rsshub / 贴吧一键签到可能会遭遇 <code>network has active endpoints</code> 问题，解决方法参考这篇文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/Dong-Ge/p/9634351.html">docker 解决network has active endpoints</a></p>
<blockquote>
<p> 使用 <code>docker network disconnect -f {network} {endpoint-name}</code>，其中的 {endpoint-name} 可以使用命令 <code>docker network inspect {network}</code> 获得 </p>
<p>而 network 通过 <code>docker network ls</code> 获得</p>
<p>最后运行 <code>docker-compose up -d</code> 即可</p>
</blockquote>
</li>
</ol>
<h4 id="filemanager（docker）"><a href="#filemanager（docker）" class="headerlink" title="filemanager（docker）"></a>filemanager（docker）</h4><p>参考资料：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.51cto.com/536410/2318111?source=dra">利用docker 搭建File Browser 文件管理系统</a>  </li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/filebrowser/filebrowser/issues/522">BaseUrl not longer honored when in url of static assets</a></li>
</ul>
<p>下载 filebrowser 镜像</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull filebrowser/filebrowser</span><br></pre></td></tr></tbody></table></figure>
<p>选好 filebrowser 配置文件夹和主文件夹（即 filebrowser 的生效文件夹）所指向的目录，注意配置文件夹不能是主文件夹的子目录，否则会有危险。配置文件夹我选择的是<code>/home/filebrowser</code>，主文件夹便是 zbttl 的默认目录 <code>/home/zbttl</code>，如果是通过 root 权限运行那么无所谓，不是的话需要注意配置文件夹权限。</p>
<p>之后在配置文件夹里面新建一个 <code>filebrowser.db</code> 文件，否则程序运行时就会自动创建同名的<strong>文件夹</strong>导致错误（我也不知道为什么会那么沙雕，反正是作者承认的 bug，当然也可以选择在下一步不映射这个文件，但如果将来要迁移 filebrowser 的话没有这个文件夹就需要重新配置）。还可以手工建一个名为 <code>.filebrowser.json</code> 的文件，如果运行时映射了但之前没建的话就会使用默认配置，root 并有单独域名的情况下使用默认配置没有问题，但如果考虑到我们的使用环境（在 zbttl 这个用户下使用），必须要做出修改，或者运行时将参数写在命令中。</p>
<p><code>.filebrowser.json</code> 这个文件的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/filebrowser/filebrowser/blob/master/.docker.json">默认配置</a>长这样：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "port": 80,</span><br><span class="line">  "baseURL": "",</span><br><span class="line">  "address": "",</span><br><span class="line">  "log": "stdout",</span><br><span class="line">  "database": "/database.db",</span><br><span class="line">  "root": "/srv"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们需要修改 port（非 root 下 1000 以下端口受限，容器内容器外都是），假设我们用 7777 这个端口。另外还有一个 baseurl，这个待会再提。</p>
<p>不修改 baseurl 的话，最后成果长这样：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "port": 7777,</span><br><span class="line">  "baseURL": "",</span><br><span class="line">  "address": "",</span><br><span class="line">  "log": "stdout",</span><br><span class="line">  "database": "/database.db",</span><br><span class="line">  "root": "/srv"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后看一眼教程里面的默认命令</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -v /home/file_browser:/srv -v /home/file_browser/config.json:/etc/config.json -v /home/file_browser/database.db:/etc/database.db -p 100:80 filebrowser/filebrowser</span><br></pre></td></tr></tbody></table></figure>
<p>冒号前是实机目录，冒号后是容器内目录。刚刚说过 config.json  实际上默认自带不需要映射，但我们修改过里面的内容（比如接下来我们要修改的 baseurl）又不想在命令里面写明的话可以做映射。选择映射到实机 100 端口，避开 http 的 80 端口。-d 的意思是，后台运行</p>
<p>根据我们的配置，做出修改：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -u 1000 --name filebrowser -v /home/zbttl:/srv -v /home/filebrowser/filebrowser.db:/database.db -v /home/filebrowser/.filebrowser.json:/.filebrowser.json -p 7777:7777 filebrowser/filebrowser</span><br></pre></td></tr></tbody></table></figure>

<p>-u 的意思是运行用户的 uid，可以通过 id 命令查询 <code>id zbttl</code>。不使用后台，看看报不报错。</p>
<p>然后用浏览器 ip:7777 即可打开。通过浏览器访问，默认账号密码：admin</p>
<p>加上后台和自启（也可以选择强行停止然后删除原容器后加上 -d 和自启参数再次运行）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br><span class="line">#复制容器名</span><br><span class="line">docker container update --restart=always 容器名字</span><br><span class="line">docker start 容器名字</span><br></pre></td></tr></tbody></table></figure>


<p>另外如果想映射到虚拟主机目录下（比如域名使用 xxx/filemanager:777 时有效)，需要加入 –baseurl 参数，可以写在刚刚的配置文件中，这里以写在命令中为例。务必加在镜像名后，如：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -u 1000 -v /home/zbttl:/srv -v /home/filebrowser/filebrowser.db:/database.db -v /home/filebrowser/.filebrowser.json:/.filebrowser.json -p 7777:7777 filebrowser/filebrowser --baseurl /filemanager/</span><br></pre></td></tr></tbody></table></figure>
<p>主要用于你想用手上现有的域名 + 虚拟主机而不是另开新的三级域名来搭建 filemanager 时使用（后面讲 nginx 时我会再提到）</p>
<h4 id="aria2-docker"><a href="#aria2-docker" class="headerlink" title="aria2 docker"></a>aria2 docker</h4><p>有条件先去看离线下载类的 aria2，配置文件和破解线程限制的指南在那里。</p>
<p><strong>(21.3.8 更新)</strong> 线程破解啥的，P3TERX 大佬喂到嘴里了。。。详情见：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/P3TERX/Aria2-Pro-Core">P3TERX/Aria2-Pro-Core: Aria2 static binaries for GNU/Linux with some powerful feature patches. | 破解无限线程 防掉线程优化 静态编译 二进制文件 增强版</a>。</p>
<p>现在作者推荐使用新版 dockerr 配合直接使用网桥模式，将 docker 端口直接透出来；bt 端口默认重新配置过，不再需要另外指定以防和 transmission 产生冲突；我思索了一下，和 transmission 相比，aria2 没法管理已经下载好的文件，所以和 vps 内 filebrowser 配合使用的 transmission 才需要正确设置权限，aria2 现在只用于直接下载然后和 rclone 配合上传文件到 onedrive，不接触 vps 内文件，就懒得老老实实配置用户给它了。</p>
<p>所以我现在的使用方法是，不做修改直接使用作者给的带有 rclone 功能的命令。将之前配置好的 rclone 文件（配置方法参考<a href="#rclone">网盘类 rclone</a>，配置完后在 <code>/root/.config/rclone/rclone.conf</code>）和证书（使用 acme.sh，参考<a href="#%E5%85%B3%E4%BA%8E%E8%AF%81%E4%B9%A6%E7%9A%84%E9%85%8D%E7%BD%AE">关于证书的配置</a>，使用 <code>acme.sh install</code> 安装到相应目录）放 / 安装到 <code>/root/aria-config</code> 中；修改 <code>aria2.conf</code> 的证书配置；修改 <code>script.conf</code> 的 rclone 网盘名和上传目的地文件夹名（和 rclone 原命令不同，目的地文件夹中有中文也不要加单引号）；配置好 <a href="#%E9%85%8D%E7%BD%AE%E5%89%8D%E7%AB%AF">aria2NG 前端</a>（因为我想配合 cf 使用，且我现在使用的 caddy 能自动帮我加证书，但 aria2NG 这边用 caddy 反代开启 https 后要求 aria2 本身也开启 ssl，开启 aria2NG ssl 后 aria2NG 协议下拉菜单 http 选项是禁用不能选的，所以上文我给 aria2 也上了 ssl），运行官方命令：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name aria2-pro \</span><br><span class="line">--restart unless-stopped \</span><br><span class="line">--log-opt max-size=1m \</span><br><span class="line">--network host \</span><br><span class="line">-e PUID=$UID \</span><br><span class="line">-e PGID=$GID \</span><br><span class="line">-e RPC_SECRET=[登录密码] \</span><br><span class="line">-e RPC_PORT=6800 \</span><br><span class="line">-e LISTEN_PORT=6888 \</span><br><span class="line">-v $PWD/aria2-config:/config \</span><br><span class="line">-v $PWD/aria2-downloads:/downloads \</span><br><span class="line">-e SPECIAL_MODE=rclone \</span><br><span class="line">p3terx/aria2-pro</span><br></pre></td></tr></tbody></table></figure>

<p>即可。</p>
<p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://p3terx.com/archives/docker-aria2-pro.html">Aria2 Pro - 更好用的 Aria2 Docker 容器镜像</a></p>
<hr>
<p>官方命令：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --name aria2-pro \</span><br><span class="line">    --restart unless-stopped \</span><br><span class="line">    --log-opt max-size=1m \</span><br><span class="line">    -e PUID=$UID \</span><br><span class="line">    -e PGID=$GID \</span><br><span class="line">    -e RPC_SECRET=&lt;TOKEN&gt; \</span><br><span class="line">    -p 6800:6800 \</span><br><span class="line">    -p 6888:6888 \</span><br><span class="line">    -p 6888:6888/udp \</span><br><span class="line">    -v ~/aria2-config:/config \</span><br><span class="line">    -v ~/downloads:/downloads \</span><br><span class="line">    p3terx/aria2-pro</span><br></pre></td></tr></tbody></table></figure>

<p>和 aria2 一键脚本相比，添加了 PUID 和 PGID 两个参数，方便以指定的身份下载文件，不过实现的方法和通用方法 -u 参数（参见 filemanager docker）不同，用了 -e 参数（实测，-e 和 -u 不可混用，需要配合具体容器使用）。两个 -v 对应的目录一个是配置目录一个是下载，这里还可以开一个 -v，链接破解过线程的 aria2 二进制文件，注意该文件需要提前加够 755 权限。另外，这里的 TOKEN 是密码，也需要进行定义。</p>
<p>根据非 docker aria2 的默认设置，下载文件放置于 <code>/home/zbttl/download/aria2</code>，程序放置于 <code>/usr/local/bin</code>，docker 内 aria2 同样放置于 <code>/usr/local/bin/</code>，配置文件 <code>aria2.conf</code> 由于和原来有一些出入（不过大概只有目标目录那里需要验证，默认的 <code>/root/Downloads</code> 不知道能不能改），所以首次使用不建议修改映射，但可以部署完后进行修改保存，下次放入 <code>/root/aria2-config/</code> 继续用。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --name aria2-pro \</span><br><span class="line">    --restart unless-stopped \</span><br><span class="line">    --log-opt max-size=1m \</span><br><span class="line">    -e PUID=1000 \</span><br><span class="line">    -e PGID=$GID \</span><br><span class="line">    -e RPC_SECRET=[登录密码] \</span><br><span class="line">    -p 6800:6800 \</span><br><span class="line">    -p 6888:6888 \</span><br><span class="line">    -p 6888:6888/udp \</span><br><span class="line">    -v ~/aria2-config:/config \</span><br><span class="line">    -v /home/zbttl/download/aria2:/downloads \</span><br><span class="line">    -v /usr/local/bin/aria2c:/usr/local/bin/aria2c \</span><br><span class="line">    p3terx/aria2-pro</span><br></pre></td></tr></tbody></table></figure>

<p>另外，这里有一个不算啥问题的问题。。。如果和 aria2 一键脚本混用且 aria2 一键脚本已安装并启动，同时打开该容器（在端口经过修改没有冲突程序打开成功的情况下），此时停止 aria2 脚本安装的 aria2 程序，然后再次运行启动脚本，会提示该脚本启动的 aria2 仍在开启。不过也不会有人无聊到混用的吧。</p>
<h4 id="amule（docker）"><a href="#amule（docker）" class="headerlink" title="amule（docker）"></a>amule（docker）</h4><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://hub.docker.com/r/tchabaud/amule">tchabaud/amule</a></p>
<p>不是官方的，不能保证更新，不过官方都几百年不更新了，无所谓了。</p>
<p>官方示例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 4712:4712 -p 4662:4662 -p 4672:4672/udp \</span><br><span class="line">    -e PUID=[wanted_uid] -e PGID=[wanted_gid] \</span><br><span class="line">    -e GUI_PWD=[wanted_password_for_gui] \</span><br><span class="line">    -v ./amule/conf:/home/amule/.aMule -v ./amule/incoming:/incoming -v ./amule/tmp:/temp tchabaud/amule</span><br></pre></td></tr></tbody></table></figure>

<p>其实经过前几个 docker 的搭建这些参数我都差不多熟悉了。。。不过这里有个小坑。 -v 这里有三个目录，按理来说，我们需要修改的 conf 参数在 docker 命令中已经包括了，所以实际上 -v 只需要映射 <code>/incoming</code> 目录就好了。然而我这么做了以后，发现下载速度比原版 amule 慢了不少。。。试了两三次，只有最后一次，放置了两三个小时后，amule 的 kad 正确的连接了，速度才正常了起来，而当正确的映射三个目录的时候，运行正常。所以看来还是得乖乖映射两个没啥用的目录。。。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/zbttl/download/amule&amp;&amp;cd /home/zbttl/download/amule</span><br><span class="line">mkdir ./conf</span><br><span class="line">mkdir ./tmp</span><br><span class="line">mkdir ./incoming</span><br><span class="line">chown -R zbttl ./conf ./tmp ./incoming</span><br><span class="line">docker run -d -p 4711:4711 -p 4662:4662 -p 4672:4672/udp     -e PUID=1000 -e PGID=1000     -e WEBUI_PWD=[登录密码]    -v /home/zbttl/download/amule/conf:/home/amule/.aMule -v /home/zbttl/download/amule/incoming:/incoming -v /home/zbttl/download/amule/tmp:/temp tchabaud/amule</span><br></pre></td></tr></tbody></table></figure>

<p>当然，不要和通常版 amule 一起使用，即使端口错开，后开那个也只能得到 low id。</p>
<h4 id="mldonkey（docker）"><a href="#mldonkey（docker）" class="headerlink" title="mldonkey（docker）"></a>mldonkey（docker）</h4><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/logicwar">logicwar</a>/<strong><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/logicwar/mldonkey">mldonkey</a></strong></p>
<p>mldonkey 普通版的配置真是一顶一的麻烦。。。而 docker 版版本旧一些（只到 3.1.5），不过作者加了一些源，而且把限速解开了无需配置，推荐使用。</p>
<p>官方示例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">docker create --name=mldonkey \</span><br><span class="line">              -v &lt;path for config files&gt;:/var/lib/mldonkey:rw \</span><br><span class="line">              -v &lt;path for temporary files&gt;:/mnt/mldonkey_tmp:rw \</span><br><span class="line">              -v &lt;path for completed downloaded files&gt;:/mnt/mldonkey_completed:rw \</span><br><span class="line">              -e PGID=&lt;gid&gt; \</span><br><span class="line">              -e PUID=&lt;uid&gt; \</span><br><span class="line">              -e TZ=&lt;timezone&gt; \</span><br><span class="line">              -p 4000:4000 \</span><br><span class="line">              -p 4001:4001 \</span><br><span class="line">              -p 4080:4080 \</span><br><span class="line">              -p 20562:20562 \</span><br><span class="line">              -p 20566:20566/udp \</span><br><span class="line">              -p 16965:16965 \</span><br><span class="line">              -p 16965:16965/udp \</span><br><span class="line">              -p 6209:6209 \</span><br><span class="line">              -p 6209:6209/udp \</span><br><span class="line">              -p 6881:6881 \</span><br><span class="line">              -p 6882:6882 \</span><br><span class="line">              -p 3617:3617/udp \</span><br><span class="line">              -p 4444:4444 \</span><br><span class="line">              -p 4444:4444/udp \</span><br><span class="line">              logicwar/mldonkey</span><br></pre></td></tr></tbody></table></figure>

<p>这次去掉不必要的映射就没啥副作用了。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run --name=mldonkey \</span><br><span class="line">              -v /home/zbttl/download/mldonkey:/mnt/mldonkey_completed:rw \</span><br><span class="line">              -e PGID=1000 \</span><br><span class="line">              -e PUID=1000 \</span><br><span class="line">              -p 4000:4000 \</span><br><span class="line">              -p 4001:4001 \</span><br><span class="line">              -p 4080:4080 \</span><br><span class="line">              -p 20562:20562 \</span><br><span class="line">              -p 20566:20566/udp \</span><br><span class="line">              -p 16965:16965 \</span><br><span class="line">              -p 16965:16965/udp \</span><br><span class="line">              -p 6209:6209 \</span><br><span class="line">              -p 6209:6209/udp \</span><br><span class="line">              -p 6881:6881 \</span><br><span class="line">              -p 6882:6882 \</span><br><span class="line">              -p 3617:3617/udp \</span><br><span class="line">              -p 4444:4444 \</span><br><span class="line">              -p 4444:4444/udp \</span><br><span class="line">              logicwar/mldonkey</span><br></pre></td></tr></tbody></table></figure>

<h4 id="vscoder"><a href="#vscoder" class="headerlink" title="vscoder"></a>vscoder</h4><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://hub.docker.com/r/linuxserver/code-server">linuxserver/code-server</a></p>
<p>新建了一个 coder 用户，用户文件夹为 <code>/home/coder</code>，<code>id coder</code> 查询结果喂 1003。</p>
<p>docker-compose.yml：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: "2.1"</span><br><span class="line">services:</span><br><span class="line">  code-server:</span><br><span class="line">    image: linuxserver/code-server</span><br><span class="line">    container_name: code-server</span><br><span class="line">    environment:</span><br><span class="line">      - PUID=1003</span><br><span class="line">      - PGID=1003</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - PASSWORD=[登录密码] #optional</span><br><span class="line">      - SUDO_PASSWORD=[linux用户密码] #optional</span><br><span class="line">    volumes:</span><br><span class="line">      - /home/coder/:/config</span><br><span class="line">    ports:</span><br><span class="line">      - 8443:8443</span><br><span class="line">    restart: unless-stopped</span><br></pre></td></tr></tbody></table></figure>

<p>另外还有一种 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/cdr/code-server">cdr/code-server</a> 我试了半天都没办法用非 root 用户映射本地目录，算了。</p>
<h3 id="离线下载类"><a href="#离线下载类" class="headerlink" title="离线下载类"></a>离线下载类</h3><h4 id="aria2（19-11-18-更新）"><a href="#aria2（19-11-18-更新）" class="headerlink" title="aria2（19.11.18 更新）"></a>aria2（19.11.18 更新）</h4><p>因为 aria2 有线程限制，所以建议自己下载源码修改以后进行编译。<del>不过编译过后的二进制文件好像会大很多的样子。。。</del></p>
<p><del>如果不需要解除线程限制的话，推荐脚本一步到位（当然也可以运行完脚本以后再把编译好的已破解限制的二进制扔进去）：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/P3TERX/aria2.sh">Aria2 一键安装管理脚本</a></del>(有权限问题，如果不在乎可以继续用，现在更推荐 docker 版，介绍在 docker 类中。)</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -N https://git.io/aria2.sh &amp;&amp; chmod +x aria2.sh &amp;&amp; bash aria2.sh</span><br></pre></td></tr></tbody></table></figure>

<h5 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h5><p>之前：</p>
<ol>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/daloyanf/article/details/78919749">linux编译安装aria2，远程下载设置</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://doubibackup.com/bizht36j-3.html">BT/种子/磁力链接/HTTP/FTP 离线下载工具 —— Aria2 新 手动安装教程</a></li>
<li><del><a target="_blank" rel="external nofollow noopener noreferrer" href="https://everdream.xyz/2017/08/aria2c-spam/">10240 线程暴力膜改版 Aria2c</a></del></li>
<li>（systemd 相关）<a target="_blank" rel="external nofollow noopener noreferrer" href="https://my.oschina.net/lemos/blog/839600">Debian 如何搭建使用 aria2c 作为下载工具 原</a></li>
</ol>
<p>编译相关：</p>
<ol>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://aria2.github.io/manual/en/html/README.html#how-to-build">官方编译指南</a></li>
<li>解决编译时的 deprecated 问题 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://weair.xyz/build-aria2/">编译安装aria2</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.v2ex.com/t/446659">为什么自己编译的 aria2 体积很大</a></li>
</ol>
<p>文件修改：</p>
<ol>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.52pojie.cn/thread-762859-1-1.html">Windows <strong>下载工具aria2 1.34.0 解除单服务器线程数限制编译版</strong> </a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/myfreeer/aria2-build-msys2">aria2-build-msys2</a>  上一个参考资料的 github 库</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://hguandl.com/post/8f0b723a.html">Aria2 魔改解除线程数限制</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/hguandl/aria2-patch">aria2-patch</a> 上一个参考资料的 github 库</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.yooomu.com/archives/22.html">修改源码突破aria2线程限制</a></li>
</ol>
<h5 id="环境和下载"><a href="#环境和下载" class="headerlink" title="环境和下载"></a>环境和下载</h5><ol>
<li><p>环境：虽然我们一开始装了一堆 gcc 编译相关环境了，但毕竟官方给了环境列表，我就一起整理列出来了</p>
 <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install  libssh2-1-dev libc-ares-dev libxml2-dev zlib1g-dev libsqlite3-dev pkg-config   libcppunit-dev autoconf automake autotools-dev autopoint libtool libssl-dev -y</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>到<code>https://github.com/aria2/aria2/releases/</code>找最新的 release，我写这篇文章的时候在 <del>1.34.0</del>1.35.0，所以输入</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aria2_new_ver="1.35.0"</span><br><span class="line">wget https://github.com/aria2/aria2/releases/download/release-${aria2_new_ver}/aria2-${aria2_new_ver}.tar.bz2</span><br></pre></td></tr></tbody></table></figure>
<p> 当然你也可以吧 tar.bz2 结尾的文件下载到电脑上再做处理。或者，用 git（那就可以跳过第三步了）</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/aria2/aria2.git</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>解压</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar jxvf "aria2-${aria2_new_ver}.tar.bz2"</span><br></pre></td></tr></tbody></table></figure>
<p> 上权限</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar jxvf "aria2-${aria2_new_ver}.tar.bz2"</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h5 id="编译源文件修改"><a href="#编译源文件修改" class="headerlink" title="编译源文件修改"></a>编译源文件修改</h5><ol>
<li><p>需要修改的是那些以 cc 为后缀的编译源文件，具体是哪几个文件可以去看参考资料 2 里面的 .patch 文件。但因为我们最主要的是修改服务器最大连接数和服务器最小分割尺寸，所以只需要修改其中的 OptionHandlerFactory.cc。</p>
</li>
<li><p>寻找 OptionHandlerFactory.cc 文件，一般在 aria2 的 src 目录里面，可以通过 find 命令来寻找</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name OptionHandlerFactory.cc</span><br></pre></td></tr></tbody></table></figure>
<p>假设在 aria2 目录下的<code>/src/OptionHandlerFactory.cc</code>内，那么输入</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /root/aria2-${aria2_new_ver}/src/OptionHandlerFactory.cc</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>文件里代码密密麻麻，有用的是类似这样的代码块：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">OptionHandler* <span class="title">op</span><span class="params">(<span class="keyword">new</span> NumberOptionHandler(PREF_MAX_CONNECTION_PER_SERVER,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               TEXT_MAX_CONNECTION_PER_SERVER,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               <span class="string">"1"</span>, <span class="number">1</span>, <span class="number">16</span>, <span class="string">'x'</span>))</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<p>其中的跟在 TEXT 后面的 <code>MAX_CONNECTION_PER_SERVER</code> 就是 aria.conf 中的 <code>max-connection-per-server</code>，也就是单服务器最大连接数，没错，就是把小写换大写，横杠换斜杠，前面加 TEXT 而已。。。所以，其他所要修改的参数名可以通过 conf 文件获取，也可以去看参考资料 1、3 里面的 patch 文件，github 已经很贴心的帮我们标了颜色进行标记了，可以按参考资料 1、3 修改过的地方，直接照抄。当然我觉得那两个改的是有点过头，比如参考资料 1 的</p>
<blockquote>
<ul>
<li>默认同时下载数改为 128</li>
<li>默认同服务器连接数改为 64，解除了之前 16 的限制</li>
</ul>
</blockquote>
<p>其实，注意到那 <code>MAX_CONNECTION_PER_SERVER</code> 后面到括号前的那几个参数了吗</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"1", 1, 16, 'x'</span><br><span class="line">默认值，最小值，最大值，单位</span><br></pre></td></tr></tbody></table></figure>

<p>限制了最小值和最大值的，其实就只有单服务器最大连接数和最小分块大小而已。 w网上最多的，是类似于参考文章 5 那样的修改，其中对默认值的修改，我认为见仁见智，其实最后直接修改配置文件也行。</p>
<p><del>然后输入<code>/TEXT_MAX_CONNECTION_PER_SERVER</code>搜索这个字符串，利用方向键切换到后面的 16 ，按下 i 改成任意整数（这里改成 10240，注意避免整型溢出），像下面这样</del></p>
<ol>
<li><p>解除单服务器连接限制，取消最大 16 的限制，默认连接设为 32 </p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OptionHandler* op(new NumberOptionHandler(PREF_MAX_CONNECTION_PER_SERVER,</span><br><span class="line">                                               TEXT_MAX_CONNECTION_PER_SERVER,</span><br><span class="line">                                               "1", 1, 16, 'x'));</span><br></pre></td></tr></tbody></table></figure>

<p>修改为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OptionHandler* op(new NumberOptionHandler(PREF_MAX_CONNECTION_PER_SERVER,</span><br><span class="line">                                               TEXT_MAX_CONNECTION_PER_SERVER,</span><br><span class="line">                                               "32", 1, -1, 'x'));</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>最小文件分片大小，取消最小 1m 的限制，默认设为 1m</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREF_MIN_SPLIT_SIZE, TEXT_MIN_SPLIT_SIZE, "20M", 1_m, 1_g, 'k'));</span><br></pre></td></tr></tbody></table></figure>
<p>修改为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREF_MIN_SPLIT_SIZE, TEXT_MIN_SPLIT_SIZE, "1M", 1_k, 1_g, 'k'));</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>最大分片数，默认设为 48。分片数和前两项也有关，比如在 http 下载环境下（必定是单服务器）如果单服务器连接限制 &lt; 最大分片数，或是剩余文件大小 / 最小文件分片大小 &lt; 最大分片数，就会取其中的最小值做当前分片数。分片做的多速度可能就快（多线程原理），但最后拼接的时候可能消耗的算力就大，连接过多也可能遭到远程服务器的限制。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new NumberOptionHandler(PREF_SPLIT, TEXT_SPLIT, "5", 1, -1, 's'));</span><br></pre></td></tr></tbody></table></figure>
<p>修改为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new NumberOptionHandler(PREF_SPLIT, TEXT_SPLIT, "48", 1, -1, 's'));</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>片段长度，取消最小 1m 的限制，默认不变。和最小文件分片大小的区别是，片段长度适用于 http 下载，将媒体文件进行分片，下好的分片部分即可进行播放。这是完成度上的参数而不是下载线程上的参数，所以该参数优先级也会小于最小文件分段长度。一般来说，这个参数比最小文件分段长度就行了。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREF_PIECE_LENGTH, TEXT_PIECE_LENGTH, "1M", 1_m, 1_g));</span><br></pre></td></tr></tbody></table></figure>
<p>修改为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREF_PIECE_LENGTH, TEXT_PIECE_LENGTH, "1M", 1_k, 1_g));</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>（可选）连接超时时间，缩短为 30s</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREF_CONNECT_TIMEOUT, TEXT_CONNECT_TIMEOUT, "60", 1, 600));</span><br></pre></td></tr></tbody></table></figure>
<p>修改为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREF_CONNECT_TIMEOUT, TEXT_CONNECT_TIMEOUT, "30", 1, 600));</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>（可选）连接重试次数，增加到 2 次。应该能看出来，5 和 6 是配合使用的，效果就是缩短超时，快速重试</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new NumberOptionHandler(PREF_RETRY_WAIT, TEXT_RETRY_WAIT, "0", 0, 600));</span><br></pre></td></tr></tbody></table></figure>
<p>修改为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new NumberOptionHandler(PREF_RETRY_WAIT, TEXT_RETRY_WAIT, "2", 0, 600));</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<p>然后按 ESC，输入 <code>:wq</code> 保存</p>
</li>
</ol>
<h5 id="编译和安装"><a href="#编译和安装" class="headerlink" title="编译和安装"></a>编译和安装</h5><ol>
<li><p>编译（512m 机子需要开虚拟内存了）</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd&amp;&amp;cd aria2-${aria2_new_ver}</span><br><span class="line">autoreconf -i</span><br></pre></td></tr></tbody></table></figure>

<p> 这里可能会遇到两个坑：</p>
<ol>
<li><p>运行 <code>autoreconf -i</code> 后提示 <code>./ltmain.sh no found</code>。输入 <code>libtoolize</code> 解决。</p>
</li>
<li><p>提示 </p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure.ac:731: warning: The 'AM_PROG_MKDIR_P' macro is deprecated, and its use is discouraged.</span><br></pre></td></tr></tbody></table></figure>

<p> 找到 <code>configure.ac</code> 文件的 <code>AM_GNU_GETTEXT_VERSION([0.18])</code> 并修改为 <code>AM_GNU_GETTEXT_VERSION([0.19])</code>，重新执行 </p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoreconf -i --force</span><br></pre></td></tr></tbody></table></figure>

<p>然后</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br></pre></td></tr></tbody></table></figure>

<p>当然这么编译出来的二进制文件只有本机能用，开启静态编译后就可以在 amd64 机子上通用了。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure ARIA2_STATIC=yes</span><br></pre></td></tr></tbody></table></figure>

<p>另外，默认不加参数的情况下用了 libxml2 这个库，这个库有个毛病，静态编译出来的二进制体积不小，通过 without 禁止调用该库系统就会自动换用  libexpat  这个库，有效降低体积。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure ARIA2_STATIC=yes --without-libxml2</span><br></pre></td></tr></tbody></table></figure>

<p>最后</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></tbody></table></figure>

<p>耐心等待。</p>
</li>
</ol>
</li>
<li><p>安装</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd src                 #编译好的aria2在这里</span><br><span class="line">cp aria2c /usr/local/bin</span><br></pre></td></tr></tbody></table></figure>

<p> 另外说一句，这里使用<code>make install</code>也可以，区别在于 make install 会把使用文档也一起拷过去，另外用 make unistall 也就可以快速卸载（不过也就只是删两个文件而已）。此时你也可以将编译好的 aria2c 文件留档保存，开新的 vps 的时候拷过去就是了。</p>
<p> 如果是使用一键脚本安装的想用编译好的无限制的二进制替换原来的 aria2c，需要先找到原来的 aria2c 放哪了 <code>which aria2c</code></p>
<p> 文章开头的这个脚本会放在 <code>/usr/bin</code> 里面，就将第二条指令改为</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp aria2c /usr/bin</span><br></pre></td></tr></tbody></table></figure>

<p> 另外，编译好的文件大小相当感人（1.34.0 77m，1.35.0 100m，静态 1.35.0 145m），是因为里面带了无用的 symbol</p>
<blockquote>
<p>  默认是动态链接生成的可执行文件，同时也包含了许多调试信息，可执行文件比较大</p>
</blockquote>
<p> 可以通过指令去除</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strip -s aria2c</span><br></pre></td></tr></tbody></table></figure>

<p> 最后大小测量出来是 2m 左右。不过如果是静态编译的话，就会达到 37m，解决方法就是上面说的换库，更换完以后大小约为 9.77m，不过官方静态编译出来的只有 7.99m，通过 <code>aria2c -v</code> 命令进行比对，官方使用的库中 sqlite3 和 c-ares 的版本较新（但 openssl 和 libssh2 的版本较旧），通过 sid 源更新了版本再次编译，emmm，缩小了到 9.55m，还是没有官方小。然后我尝试过降级，把库降级到官方静态版编译时用的版本</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Libraries: zlib/1.2.11 expat/2.2.6 sqlite3/3.30.1 OpenSSL/1.1.1d c-ares/1.15.0 libssh2/1.8.0</span><br><span class="line">Libraries: zlib/1.2.11 expat/2.2.6 sqlite3/3.30.0 OpenSSL/1.0.2t c-ares/1.15.0 libssh2/1.7.0</span><br><span class="line"># 上面那个是我编译出的 aria2 使用的库</span><br></pre></td></tr></tbody></table></figure>

<p> 结果发现坑巨大。。。apt 本身不收录历史版本，所以只得用手动编译的方法。一共编译三个东西：</p>
<ul>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.howtoforge.com/tutorial/how-to-install-openssl-from-source-on-linux/">openssh</a></p>
</li>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/jinzhu1911/article/details/81329240">sqlite3</a></p>
</li>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linuxfromscratch.org/blfs/view/svn/general/libssh2.html">libssh2</a></p>
<p>前两个表现形式是二进制文件，最后一个是库。库最好装，二进制文件的话麻烦的多，参考第一篇文章，但需要做出两个改动：</p>
</li>
<li><p>debian 的环境变量改那个文件没有用，需要写到 <code>~/.bashrc</code> 才行</p>
</li>
<li><p>需要手动删除或 apt remove 或者一次性备份 <code>/usr/bin</code> 的同名二进制，自己安装的二进制才能被识别为系统默认。</p>
<p>然而。。。最后发现也没有用，编译时只认 apt 装的，手动装的不认。遂放弃。</p>
</li>
</ul>
</li>
</ol>
<h5 id="下载配置建立"><a href="#下载配置建立" class="headerlink" title="下载配置建立"></a>下载配置建立</h5><ol>
<li><p>接下来需要创建两个相关文件，分别是 aria2.conf（配置文件），aria2.session（下载任务暂存）</p>
<ol>
<li><p><code>aria2.conf</code></p>
<p> 主要需要修改的地方是文件保存路径，进度相关路径，rpc 端口和令牌；</p>
<p> 另外还建议修改以下内容（下面已经基本修改好了）</p>
<ul>
<li>aria2 配置的 <code>split</code> 和 <code>max-connection-per-server</code> 最好设置成相同的值，这样能够最大化利用每个线程来下载;</li>
<li>把 <code>max-tries</code> 设为 0，<code>retry-wait</code> 设为 5（大于零整数，不要太小），这样当线程太多而被服务器返回 50X 时能自动重连，保持总线程数不下降;</li>
<li><code>max-file-not-found</code> 设为 0 （此项默认就是 0），无限等待服务器发送数据直到完成下载。</li>
</ul>
</li>
</ol>
<ul>
<li><p>（如果要和 transmission 混用下载 bt 的话，我个人觉得没有必要，bt 全部交给 tm 就好）<code>listen-port</code> 改成其他数字，51413 和 tm 有冲突。 </p>
<ul>
<li><p>某些老古董（比如 tx 云）还在使用 ext3，那么就需要修改 <code>file-allocation</code>，除了 <code>falloc</code> 以外都可以。</p>
<p>还有一个要手工添加的 bt-tracker，需要在最末尾添加<code>bt-tracker=</code>,等号后面跟上 tracker 网址。tracker 网址可以从<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ngosang/trackerslist">这里</a>找，然后复制到有正则功能的编辑器里面（比如 notepad++，注意 vscode 不行），将<code>(?&lt;=\r\n)\r\n</code>替换为空，将<code>\r\n</code>替换为逗号，即可。</p>
<p>例子：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">    ## '#'开头为注释内容, 选项都有相应的注释说明, 根据需要修改 ##</span><br><span class="line">    ## 被注释的选项填写的是默认值, 建议在需要修改时再取消注释  ##</span><br><span class="line">    </span><br><span class="line">    ## 文件保存相关 ##</span><br><span class="line">    </span><br><span class="line">    # 文件的保存路径(可使用绝对路径或相对路径), 默认: 当前启动位置</span><br><span class="line">    dir=/home/zbttl/download/aria2</span><br><span class="line">    # 启用磁盘缓存, 0为禁用缓存, 需1.16以上版本, 默认:16M</span><br><span class="line">    #disk-cache=32M</span><br><span class="line">    # 文件预分配方式, 能有效降低磁盘碎片, 默认:prealloc</span><br><span class="line">    # 预分配所需时间: none &lt; falloc ? trunc &lt; prealloc</span><br><span class="line">    # falloc和trunc则需要文件系统和内核支持</span><br><span class="line">    # NTFS建议使用falloc, EXT3/4建议trunc, MAC 下需要注释此项</span><br><span class="line">    # file-allocation=none</span><br><span class="line">    # 断点续传</span><br><span class="line">    continue=true</span><br><span class="line">    </span><br><span class="line">    ## 下载连接相关 ##</span><br><span class="line">    </span><br><span class="line">    # 最大同时下载任务数, 运行时可修改, 默认:5</span><br><span class="line">    max-concurrent-downloads=10</span><br><span class="line">    # 同一服务器连接数, 添加时可指定, 默认:1</span><br><span class="line">    max-connection-per-server=32</span><br><span class="line">    # 最小文件分片大小, 添加时可指定, 取值范围1M -1024M, 默认:20M</span><br><span class="line">    # 假定size=10M, 文件为20MiB 则使用两个来源下载; 文件为15MiB 则使用一个来源下载</span><br><span class="line">    min-split-size=1M</span><br><span class="line">    # 单个任务最大线程数, 添加时可指定, 默认:5</span><br><span class="line">    split=32</span><br><span class="line">    # 整体下载速度限制, 运行时可修改, 默认:0</span><br><span class="line">    #max-overall-download-limit=0</span><br><span class="line">    # 单个任务下载速度限制, 默认:0</span><br><span class="line">    #max-download-limit=0</span><br><span class="line">    # 整体上传速度限制, 运行时可修改, 默认:0</span><br><span class="line">    max-overall-upload-limit=1M</span><br><span class="line">    # 单个任务上传速度限制, 默认:0</span><br><span class="line">    #max-upload-limit=1000</span><br><span class="line">    # 禁用IPv6, 默认:false</span><br><span class="line">    disable-ipv6=false</span><br><span class="line">    </span><br><span class="line">    ## 进度保存相关 ##</span><br><span class="line">    </span><br><span class="line">    # 从会话文件中读取下载任务</span><br><span class="line">    input-file=/root/aria2/aria2.session</span><br><span class="line">    # 在Aria2退出时保存`错误/未完成`的下载任务到会话文件</span><br><span class="line">    save-session=/root/aria2/aria2.session</span><br><span class="line">    # 定时保存会话, 0为退出时才保存, 需1.16.1以上版本, 默认:0</span><br><span class="line">    save-session-interval=60</span><br><span class="line">    </span><br><span class="line">    ## RPC相关设置 ##</span><br><span class="line">    </span><br><span class="line">    # 启用RPC, 默认:false</span><br><span class="line">    enable-rpc=true</span><br><span class="line">    # 允许所有来源, 默认:false</span><br><span class="line">    rpc-allow-origin-all=true</span><br><span class="line">    # 允许非外部访问, 默认:false</span><br><span class="line">    rpc-listen-all=true</span><br><span class="line">    # 事件轮询方式, 取值:[epoll, kqueue, port, poll, select], 不同系统默认值不同</span><br><span class="line">    #event-poll=select</span><br><span class="line">    # RPC监听端口, 端口被占用时可以修改, 默认:6800</span><br><span class="line">    rpc-listen-port=6800</span><br><span class="line">    # 设置的RPC授权令牌, v1.18.4新增功能, 取代 --rpc-user 和 --rpc-passwd 选项</span><br><span class="line">    rpc-secret=[登录密码]</span><br><span class="line">    # 设置的RPC访问用户名, 此选项新版已废弃, 建议改用 --rpc-secret 选项</span><br><span class="line">    #rpc-user=&lt;USER&gt;</span><br><span class="line">    # 设置的RPC访问密码, 此选项新版已废弃, 建议改用 --rpc-secret 选项</span><br><span class="line">    #rpc-passwd=&lt;PASSWD&gt;</span><br><span class="line">    # 是否启用 RPC 服务的 SSL/TLS 加密,</span><br><span class="line">    # 启用加密后 RPC 服务需要使用 https 或者 wss 协议连接</span><br><span class="line">    #rpc-secure=true</span><br><span class="line">    # 在 RPC 服务中启用 SSL/TLS 加密时的证书文件(.pem/.crt)</span><br><span class="line">    #rpc-certificate=/root/xxx.pem</span><br><span class="line">    # 在 RPC 服务中启用 SSL/TLS 加密时的私钥文件(.key)</span><br><span class="line">    #rpc-private-key=/root/xxx.key</span><br><span class="line">    </span><br><span class="line">    ## BT/PT下载相关 ##</span><br><span class="line">    </span><br><span class="line">    # 当下载的是一个种子(以.torrent结尾)时, 自动开始BT任务, 默认:true</span><br><span class="line">    follow-torrent=true</span><br><span class="line">    # BT监听端口, 当端口被屏蔽时使用, 默认:6881-6999</span><br><span class="line">    listen-port=51414</span><br><span class="line">    # 单个种子最大连接数, 默认:55</span><br><span class="line">    #bt-max-peers=55</span><br><span class="line">    # 打开DHT功能, PT需要禁用, 默认:true</span><br><span class="line">    enable-dht=true</span><br><span class="line">    # 打开IPv6 DHT功能, PT需要禁用</span><br><span class="line">    #enable-dht6=false</span><br><span class="line">    # DHT网络监听端口, 默认:6881-6999</span><br><span class="line">    #dht-listen-port=6881-6999</span><br><span class="line">    # 本地节点查找, PT需要禁用, 默认:false</span><br><span class="line">    #bt-enable-lpd=true</span><br><span class="line">    # 种子交换, PT需要禁用, 默认:true</span><br><span class="line">    enable-peer-exchange=true</span><br><span class="line">    # 每个种子限速, 对少种的PT很有用, 默认:50K</span><br><span class="line">    #bt-request-peer-speed-limit=50K</span><br><span class="line">    # 客户端伪装, PT需要</span><br><span class="line">    peer-id-prefix=-TR2770-</span><br><span class="line">    user-agent=Transmission/2.77</span><br><span class="line">    # 当种子的分享率达到这个数时, 自动停止做种, 0为一直做种, 默认:1.0</span><br><span class="line">    seed-ratio=0.1</span><br><span class="line">    # 强制保存会话, 即使任务已经完成, 默认:false</span><br><span class="line">    # 较新的版本开启后会在任务完成后依然保留.aria2文件</span><br><span class="line">    force-save=true</span><br><span class="line">    # BT校验相关, 默认:true</span><br><span class="line">    #bt-hash-check-seed=true</span><br><span class="line">    # 继续之前的BT任务时, 无需再次校验, 默认:false</span><br><span class="line">    bt-seed-unverified=true</span><br><span class="line">    # 保存磁力链接元数据为种子文件(.torrent文件), 默认:false</span><br><span class="line">    #bt-save-metadata=true</span><br><span class="line">    </span><br><span class="line">    #把 max-tries 设为 0，retry-wait 设为 5（大于零整数，不要太小），这样当线程太多而被服务器返回 50X 时能自动重连，保持总线程数不下降;</span><br><span class="line">    max-tries=0</span><br><span class="line">    retry-wait=5</span><br><span class="line">    #max-file-not-found 设为 0 （此项默认就是 0），无限等待服务器发送数据直到完成下载。</span><br><span class="line">max-file-not-found=0</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ol start="2">
<li><code>aria2.session</code> 只要建立在 conf 内写的相应目录处就可以了</li>
</ol>
</li>
</ul>
</li>
<li><p>配置自启动</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/supervisor/conf.d/aria2</span><br></pre></td></tr></tbody></table></figure>

<p> 然后输入（注意 conf 路径）</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[program:aria2]</span><br><span class="line">command=aria2c --conf-path=/root/aria2/aria2.conf -D</span><br><span class="line">autorestart=true  </span><br><span class="line">user=root </span><br></pre></td></tr></tbody></table></figure>

<p> 通过 supervisorctl reload 进行重启</p>
<p> 或者也可以使用 systemd 来配置自启，输入<code>nano /usr/lib/systemd/system/aria2c.service</code></p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Aria2c</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/usr/bin/aria2c --conf-path=/etc/aria2/aria2.conf</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=42s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure>

<p> 保存后启动服务</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable aria2c.service</span><br><span class="line">systemctl restart aria2c.service</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h5 id="配置前端"><a href="#配置前端" class="headerlink" title="配置前端"></a>配置前端</h5><p>从<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/mayswind/AriaNg/releases">这里</a>下载 AriaNG 最新版。</p>
<p>然后放到上传到一个文件夹里面，我选择<code>/home/ariaNG/</code></p>
<p>然后再 nginx 配置文件中的某一个站点写入</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /aria2 {</span><br><span class="line">   #用alias表示最终url不包含中/aria2/目录</span><br><span class="line">      alias /home/ariaNG/;</span><br><span class="line">      index index.html;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>即可通过<code>网址/aria2</code>打开前端，输入密码即可使用。</p>
<h4 id="transmission（选用）"><a href="#transmission（选用）" class="headerlink" title="transmission（选用）"></a>transmission（选用）</h4><p>一般而言，http 下载我偏爱 aria2，而挂 pt 我就喜欢用 transmission 了。</p>
<p>参考文章：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ronggang/transmission-web-control/wiki/Linux-Installation-CN">在 Linux 下安装与更新</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://wiki.debian.org/BitTorrent/Transmission">Transmission</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tsukkomi.org/post/set-ngxin-https-reverse-proxy-to-transmission-web-ui">Ngxin HTTPS代理Transmission Web UI</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.ephestione.it/change-user-of-transmission-daemon-under-debian-and-raspbian/">CHANGE USER OF TRANSMISSION-DAEMON UNDER DEBIAN AND RASPBIAN</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/transmission/transmission/issues/342">Failed to set receive buffer UDP in Debian Solution?</a></li>
</ul>
<ol>
<li><p>安装 transmission</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install  transmission</span><br><span class="line">apt install  transmission-daemon</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>建立下载文件夹</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/zbttl/download/transmission</span><br><span class="line">chmod 777 /home/zbttl/download/transmission</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>修改配置</p>
<ol>
<li><p>先停止服务</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service transmission-daemon stop</span><br></pre></td></tr></tbody></table></figure>

<p>注意一定要停止后再修改，而不能修改完再重启。</p>
</li>
<li><p>修改 <code>/etc/init.d/transmission-daemon</code>，将其中的 user 等号后面的名字改成 zbttl。</p>
</li>
<li><p>修改<code>/lib/systemd/system/transmission-daemon.service</code>，同样是将 Service 中的 user 改成 zbttl。然后使用<code>systemctl daemon-reload</code>刷新配置。</p>
</li>
<li><p>寻找配置文件。这里注意一件事，未修改用户之前 transmission 的默认用户为 www-data，通过<code>cat /etc/passwd</code>可以看到默认目录在<code>/var/lib/transmission-daemon/</code>，所以配置文件就为其目录下的<code>.config/transmission-daemon/settings.json</code>。当然为了配置方便，该文件其实是连接到<code>/etc/transmission-daemon/settings.json</code>里的，直接去改这玩意也行。不过，更换了用户以后，配置文件就跑到用户目录下<code>.config/transmission-daemon/settings.json</code>，可以通过带连接的 cp 命令把 /etc/transmission-daemon/ 整个考过来，也可以等其生成后再停下来改。不过卸载的时候这三者都不会被删除，但是如果你手动删掉 /etc 下的这个快捷方式文件夹，重新安装之后不会自动生成。而另外两个文件夹内文件会自动在运行时生成。我们这里选择自动生成。</p>
<p>不过上面说的这些实际执行起来还有各种诡异的变化，表现在两点：</p>
<ol>
<li><code>/etc/transmission-daemon/ </code>里面的配置文件和 <code>.config/transmission-daemon/settings.json</code> 里面的配置文件部分不同步，注意是部分，在我这里反映出就是目录用户密码都同步了，但 <code>rpc-whitelist-enabled</code> 用户文件那边变成 <code>true</code> 了，然后就弹出 403 错误；</li>
<li>权限不一致。<code>/etc/transmission-daemon/ </code> 里面的数据库文件莫名其妙拥有者变成了默认用户，导致原来种子的资料读不出来。</li>
</ol>
<p>对症下药把，也没摸出什么规律来。</p>
<p>回到正题。</p>
<p>先切换用户<code>su zbttl</code></p>
<p>测试前台开启命令<code>transmission-daemon -f</code></p>
<p>此时会看见日志里面有自带创建文件的提示。同时非 root 下还会出现 udp failed 的提示，这里我们先不管，下面解决。</p>
</li>
<li><p>打开生成的文件<code>nano /home/zbttl/.config/transmission-daemon/settings.json</code></p>
<p>修改配置文件：</p>
<p>我打算修改一下<code>"download-dir": "/var/lib/transmission-daemon/downloads"</code>修改到<code>/home/zbttl/download/transmission</code>里面，另外还有<code>rpc-password</code>和<code>rpc-username</code>要设置，<code>rpc-whitelist-enabled</code>更改为false，默认 rpc 端口 9091，如果有冲突也需要修改一下。<code>port-forwarding-enabled</code>改成 false，<code>rpc-authentication-required</code>改成 true，允许使用域名代替 ip 访问。</p>
<p>设置完后经过前台开始命令，并通过浏览器查看是否能够访问。</p>
</li>
<li><p>切换回来<code>su</code> </p>
<p>针对 udp failed 问题，修改<code>/etc/sysctl.conf</code>，新增下面两行</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.core.rmem_max = 4194304</span><br><span class="line">net.core.wmem_max = 1048576</span><br></pre></td></tr></tbody></table></figure>

<p>应用</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></tbody></table></figure>

<p>最后重新启动</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service transmission-daemon start </span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
</li>
<li><p>安装美化</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/ronggang/transmission-web-control/raw/master/release/install-tr-control-cn.sh|bash</span><br></pre></td></tr></tbody></table></figure>

<p>按下「1」即可。</p>
<p>此时输入<code>ip:9091</code>，之后输入 <code>rpc-password</code>和<code>rpc-username</code> 就能顺利登录了。如果不能正常加载美化界面，请使用硬性重新加载。</p>
</li>
<li><p>和 nginx 配合使用</p>
<p>如果需要通过网址访问，则需要在nginx 配置文件中的某一个站点写入</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    location ^~ /transmission {</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-NginX-Proxy true;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection "";</span><br><span class="line">        proxy_pass_header X-Transmission-Session-Id;</span><br><span class="line">        add_header   Front-End-Https   on;</span><br><span class="line"></span><br><span class="line">        location /transmission/rpc {</span><br><span class="line">            proxy_pass http://127.0.0.1:9091;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /transmission/web/ {</span><br><span class="line">            proxy_pass http://127.0.0.1:9091;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /transmission/upload {</span><br><span class="line">            proxy_pass http://127.0.0.1:9091;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /transmission/web/style/ {</span><br><span class="line">            alias /usr/share/transmission/web/style/;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /transmission/web/javascript/ {</span><br><span class="line">            alias /usr/share/transmission/web/javascript/;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /transmission/web/images/ {</span><br><span class="line">            alias /usr/share/transmission/web/images/;</span><br><span class="line">        }</span><br><span class="line">        location /transmission/ {</span><br><span class="line">            return 301 http://$server_name/transmission/web;</span><br><span class="line">            #如果是使用 https 请换成这句</span><br><span class="line">            #return 301 https://$server_name/transmission/web;</span><br><span class="line">        }</span><br><span class="line">        #另外，我想要访问网址的 /download 后缀也能进入 transmission</span><br><span class="line">        location /download {</span><br><span class="line">            return 301 http://$server_name/transmission/web;</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>即可使用。</p>
</li>
</ol>
<h4 id="Simple-Torrent（选做）"><a href="#Simple-Torrent（选做）" class="headerlink" title="Simple Torrent（选做）"></a>Simple Torrent（选做）</h4><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.moerats.com/archives/1023/">Simple Torrent：一个支持边下边播、无版权限制和自动上传的BT离线下载程序</a></p>
<p>相比 aria2 和 transmission，这玩意能开 obfs 混淆一定程度防止 bt 追查。</p>
<p>这玩意有 docker，但不支持指定用户，只能硬着头皮上通常版了。</p>
<ol>
<li><p>一键脚本安装</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(wget -qO- https://raw.githubusercontent.com/boypt/simple-torrent/master/scripts/quickinstall.sh)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>修改 <code>/etc/systemd/system/multi-user.target.wants/cloud-torrent.service</code></p>
<p>修改以下项目</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User=zbttl #运行用户</span><br><span class="line">WorkingDirectory=/home/zbttl #运行用户的主目录</span><br><span class="line">ExecStart=/usr/local/bin/cloud-torrent -c /home/zbttl/download/cloudtorrent/cloud-torrent.json --host 0.0.0.0 --disable-log-time #cloud-torrent 最好改成绝对路径</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>改 <code>/root/cloud-torrent.json</code></p>
<p>修改以下项目</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"downloaddirectory": "/home/zbttl/download/cloudtorrent/downloads", #待会用的下载文件夹</span><br><span class="line">"obfsrequirepreferred": true, #obfs 加密优先</span><br><span class="line">"trackerlisturl": "https://trackerslist.com/all.txt", #想要tracker全一点</span><br><span class="line">"watchdirectory": "/home/zbttl/download/cloudtorrent/torrents" #待会用的种子文件夹</span><br></pre></td></tr></tbody></table></figure>

<p>复制到第二部写的 cloud-torrent 路径里面，修改所有者</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /root/cloud-torrent.json/home/zbttl/download/cloudtorrent/cloud-torrent.json</span><br><span class="line">chown zbttl/home/zbttl/download/cloudtorrent/cloud-torrent.json</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>新建下载和种子文件夹</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/zbttl/download/cloudtorrent/downloads</span><br><span class="line">mkdir -p /home/zbttl/download/cloudtorrent/torrents</span><br><span class="line">chown zbttl /home/zbttl/download/cloudtorrent/downloads /home/zbttl/download/cloudtorrent/torrents</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>重启服务</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart cloud-torrent</span><br></pre></td></tr></tbody></table></figure>

<p>通过 ip:3000 访问</p>
</li>
</ol>
<h4 id="filebrowser（普通）"><a href="#filebrowser（普通）" class="headerlink" title="filebrowser（普通）"></a>filebrowser（普通）</h4><p>不依赖 caddy 和 docker 的普通版 filebrowser。</p>
<p>参考资料：</p>
<ul>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.filebrowser.xyz/">官方文档</a></p>
</li>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.mivm.cn/filebrowser/">File Browser 安装及使用</a></p>
</li>
</ul>
<ol>
<li><p>安装</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://filebrowser.xyz/get.sh | bash</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>配置。filebrowser 支持两种方法的配置：数据库配置和文件配置。数据库配置不能直接编辑，可以通过数条命令进行编辑。而文件配置方法可以先用命令导出编辑后再导入，但是貌似没有什么例子来说明如何修改导出的文件。。。于是我们选用数据库方案。<a target="_blank" rel="external nofollow noopener noreferrer" href="https://2333blog.com/post/26/">配置文件法参考</a></p>
<p>新建一个数据库，建立在 <code>/etc/filebrowser</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebrowser -d /etc/filebrowser.db config init</span><br></pre></td></tr></tbody></table></figure>

<p>设置监听地址，这里可以写实机外部 ip，也可以写 0.0.0.0，但是不能写 127.0.0.1</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebrowser -d /etc/filebrowser.db config set --address 0.0.0.0</span><br></pre></td></tr></tbody></table></figure>

<p>设置端口</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebrowser -d /etc/filebrowser.db config set --port 100</span><br></pre></td></tr></tbody></table></figure>

<p>设置语言环境</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebrowser -d /etc/filebrowser.db config set --locale zh-cn</span><br></pre></td></tr></tbody></table></figure>

<p>设置日志位置</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebrowser -d /etc/filebrowser.db config set --log /var/log/filebrowser.log</span><br></pre></td></tr></tbody></table></figure>

<p>添加用户</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebrowser -d /etc/filebrowser.db users add root password --perm.admin</span><br></pre></td></tr></tbody></table></figure>

<p>启动</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebrowser -d /etc/filebrowser.db</span><br></pre></td></tr></tbody></table></figure>

<p>此时即可通过 ip 进行访问。</p>
<p>确定可使用后，中段程序，设置自启：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/supervisor/conf.d/filebrowser</span><br></pre></td></tr></tbody></table></figure>

<p>打入代码</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[program:filebrowser] </span><br><span class="line">command=filebrowser -d /etc/filebrowser.db</span><br><span class="line">autorestart=true  </span><br><span class="line">user=root  </span><br></pre></td></tr></tbody></table></figure>

<p>重启 supervisor <code>supervisorctl restart</code></p>
</li>
</ol>
<h4 id="amule（选用）"><a href="#amule（选用）" class="headerlink" title="amule（选用）"></a>amule（选用）</h4><p>还有某些 ed2k 链接 tr 和 aria2 是搞不掂的。得用专用的电驴下载工具（其实比较著名的 ed2k 也就是 msdn 了）。不过其实 amule 协议由于某种原因在和 bt 的竞争中已经落于下风濒临死亡，目前常用的两个工具都许久没有更新，都有比较要命的 bug，所以我两个都说一下，任选其一安装。</p>
<p>参考文章：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://wiki.debian.org/aMule">aMule</a></li>
<li>[How to setup AMule and control it via web interface on a Raspberry Pi](How to setup AMule and control it via web interface on a Raspberry Pi)</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tieba.baidu.com/p/5508629232?red_tag=2301445028#116899889402l">Debian系统如何安装aMule ?</a></li>
</ul>
<ol>
<li><p>安装 amule-daemon（没错，只要装这个就好了，其他都不用）</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install amule-daemon</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>修改 amule 的启动用户和启动文件夹</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/default/amule-daemon</span><br></pre></td></tr></tbody></table></figure>

<p>这里我的 user 设置为 zbttl，文件夹设置为 <code>/home/zbttl/download/amule</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AMULED_USER="zbttl"</span><br><span class="line">AMULED_HOME="/home/zbttl/download/amule"</span><br></pre></td></tr></tbody></table></figure>

<p>设置完以后重启一遍服务</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service amule-daemon start</span><br></pre></td></tr></tbody></table></figure>

<p>接下来才会在刚刚设置的文件夹里面放置程序文件</p>
<p>然后停止进程（也许不需要）</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service amule-daemon stop</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>运行一边 amuled 命令</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">amuled</span><br></pre></td></tr></tbody></table></figure>

<p>在刚刚设置的文件夹里就会出现关键配置文件 amule.conf</p>
<p>修改其中的几个参数 `</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ECPassword=[处理过的密码]</span><br><span class="line">[WebServer]</span><br><span class="line">Enabled=1</span><br><span class="line">Password=[处理过的密码]</span><br></pre></td></tr></tbody></table></figure>

<p>其中的两个密码需要通过命令处理生成</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n [密码] | md5sum | cut -d ' ' -f 1</span><br></pre></td></tr></tbody></table></figure>

<p>两个密码可以填一样的，实际上登录的时候只有后一个密码有用，前一个密码填啥都行</p>
<p>上面的配置方法其实是抄了近路，正经的配置方法是只配置 <code>ECPassword</code>，保存后</p>
<p>用命令生成并配置 webserver 的密码</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">amuleweb --write-config --host=localhost --password=[未处理过的Password] --admin-pass=[未处理过的 ECPassword]</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>重启，即可使用，通过 <code>ip:4711</code> 访问</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service amule-daemon start</span><br></pre></td></tr></tbody></table></figure>

<p>不进行调试的情况下，普遍 amule 下载速度貌似比下面这个快。但缺点是有时候会出现奇怪的错误，需要手动重启进程，这个错误在官方 github 上面可以找到类似的（还是两个，下面这是其中一个）：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/amule-project/amule/issues/121">../../src/CFile.cpp(370): assert “Assert failure” failed in doSeek(): ((IsOpened()))</a>。</p>
<p>opened 了很久，无人解决，上一次更新在 2015 年，估计凉了。</p>
</li>
</ol>
<h4 id="mldonkey（选用）"><a href="#mldonkey（选用）" class="headerlink" title="mldonkey（选用）"></a>mldonkey（选用）</h4><p>mldonkey 相对比较稳定，但部署上确实比较麻烦。。。</p>
<p>参考文章：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://forum.ubuntu.com.cn/viewtopic.php?t=327518">Ubuntu自带的mldonkey-server启动脚本详解</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.polarxiong.com/archives/Ubuntu-MLDonkey%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4%E5%92%8C%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9.html">Ubuntu:MLDonkey安装步骤和一些注意事项</a>（改配置文件法，不成功）</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://mldonkey.sourceforge.net/Quickstart_guide#Initial_Setup_and_Usage">Quickstart guide</a>（官方安装文档）</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://mldonkey.sourceforge.net/MLdonkeyOptionsExplained#Download">MLdonkeyOptionsExplained</a>（官方文档，全配置参数）</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://mldonkey.sourceforge.net/MultiUser">MultiUser</a>（官方文档，用户管理）</li>
</ul>
<ol>
<li><p>安装 mldonkey 和 telnet</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install mldonkey-server</span><br><span class="line">apt install telnet</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>停止程序运行</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/mldonkey-server stop</span><br></pre></td></tr></tbody></table></figure>

<p>运行一遍程序</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlnet</span><br></pre></td></tr></tbody></table></figure>

<p>开启另一个 ssh 窗口，尝试使用 telnet 登录配置端</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 127.0.0.1 4000</span><br></pre></td></tr></tbody></table></figure>

<p>成功的话输入 <code>exit</code> 退出。</p>
</li>
<li><p>修改用户和下载目录配置文件 <code>/etc/default/mldonkey-server</code>，修改以下部分</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MLDONKEY_DIR=/home/zbttl/download/mldonkey #mldonkey 程序配置文件目录</span><br><span class="line">MLDONKEY_USER=zbttl #运行用户</span><br><span class="line">MLDONKEY_GROUP=zbttl</span><br></pre></td></tr></tbody></table></figure>

<p>拷贝原来的 mldonkey 配置文件到新的程序配置文件目录，默认在 <code>/root/.mldonkey</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r /root/.mldonkey/* /home/zbttl/download/mldonkey/</span><br></pre></td></tr></tbody></table></figure>

<p>修改运行配置文件 <code>/etc/init.d/mldonkey-server</code>，修改以下部分</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PIDDIR=/home/zbttl/download/mldonkey #配置程序文件目录</span><br><span class="line">LOGFILE=/home/zbttl/download/mldonkey/mldonkey-server.log #日志目录1</span><br><span class="line">SERVERLOG=/home/zbttl/download/mldonkey/mlnet.log #日志目录2</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>修改配置文件/日志目录的用户，像我一样把所有文件放一块的，对一个文件夹配置就好了</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R zbttl /home/zbttl/download/mldonkey</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>重启服务</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">sudo /etc/init.d/mldonkey-server restart</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>再次登录 telnet</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 127.0.0.1 4000</span><br></pre></td></tr></tbody></table></figure>

<p>初始用户 admin，进入 telnet 时未重置过密码即使用该用户，通过 passwd 命令设置密码</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd [密码]</span><br></pre></td></tr></tbody></table></figure>

<p>密码在 telnet 和 web 下通用。</p>
<p>下次登录 telnet 时需要输入密码才可相应各个命令</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth admin [密码]</span><br></pre></td></tr></tbody></table></figure>

<p>还可通过 useradd 添加新用户</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd zbttl [密码] </span><br></pre></td></tr></tbody></table></figure>

<p>关闭 ip 限制</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set allowed_ips 0.0.0.0/0</span><br></pre></td></tr></tbody></table></figure>

<p>此时就可以通过 <code>ip:4080</code> 登录 web 界面。</p>
<p>剩下的参数，可以查询官方文档参数名，然后通过 set 指令调整，如果想知道当前参数默认值，可以通过 grep -r 查询，比如：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -r allowed_ips</span><br></pre></td></tr></tbody></table></figure>

<p>另外在 gui 里面大部分参数亦可以调节，不过 gui 要找到参数的文件可能更麻烦。。。</p>
</li>
<li><p>web 内参数较 amule 多很多，但最重要的是 settings 里面的 max_hard_download_rate，初始限速 50kb。往高了调吧。</p>
</li>
</ol>
<p>另外，第六部有的教程里是通过直接调节 download.ini 文件内容，我之前尝试了一下，姿势不对，调节完 mldonkey 进程的启动不起来了，甚至需要重启来解决，重启后配置又还原了。。。</p>
<h3 id="远程控制类"><a href="#远程控制类" class="headerlink" title="远程控制类"></a>远程控制类</h3><h4 id="vnc"><a href="#vnc" class="headerlink" title="vnc"></a>vnc</h4><p>有时候，下载某些不可描述的东西会碰到一些下的慢又限制重复 ip 的网盘，用自己的电脑下的话，又久，一断电又前功尽弃了。这时不如远程操作 vps，使用上面的远程桌面来下载，在 vps 上下完再下到自己的电脑上。linux 的远程桌面，一般我们使用 vnc。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-debian-9"> How to Install and Configure VNC on Debian 9</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zhuanlan.zhihu.com/p/26843097">VPS开启VNC服务，并解决中文乱码的方法——ubuntu系统</a></li>
</ul>
<ol>
<li><p>安装 tightvnc</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install tightvncserver</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>安装语言包</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install ttf-wqy-zenhei</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动<code>vncserver</code>，会提示让你输入密码，最多 8 位，多于 8 位会警告并被截断。输入完密码后会提醒你是否创建 view-only 密码，选择否。之后查看 ssh 内输出，应该是<code>主机名:1</code>，这里的「:1」的意思是 「5900+1」，也就是 vnc 运行在 5901 端口。</p>
</li>
<li><p>下载 windows 端 vnc viewer，新建一个远程主机，地址为<code>ip:5901</code>，然后输入密码，便能够看到图形界面了。如果发现连不上，有可能是你开着代理，或者是 vnc viewer 自动识别了你的代理地址，左上角<code>file-&gt;preferences-&gt;proxy</code>，选择第一项。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/3vV2Bp4.png"></p>
<p>我们看到这里实际上只有一个命令行窗口在工作，是因为系统里面还没有图形化桌面。图形化桌面有名的有 kde，ghome，xfce，由于我们的 vps 内存较小，我们就选择占用最小的 xfce 来安装。</p>
</li>
<li><p>安装 xfce</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install xfce4 xfce4-goodies</span><br></pre></td></tr></tbody></table></figure>

<p>然后重启 vnc</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vncserver -kill :1</span><br><span class="line">vncserver</span><br></pre></td></tr></tbody></table></figure>

<p>即可在 windows 端查看效果（不需要像其他教程那样修改 xstartup 文件）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/Dufepps.png"></p>
</li>
<li><p>安装浏览器</p>
<p>firefox 是最容易安装的，不过资源占用可能有点大</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install firefox-esr</span><br></pre></td></tr></tbody></table></figure>

<p>安装完后，vnc 内的浏览器图标才能够正常打开。</p>
</li>
</ol>
<h4 id="tiny-remote-desktops-（20-12-23-更新）"><a href="#tiny-remote-desktops-（20-12-23-更新）" class="headerlink" title="tiny-remote-desktops （20.12.23 更新）"></a>tiny-remote-desktops <strong>（20.12.23 更新）</strong></h4><p>来自：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://renzhn.github.io/posts/vps-remote-de/">Linux VPS一键搭建远程桌面（包含Chrome和Firefox）教程</a></p>
<p>一个 rdp + vnc + noVNC 的 docker。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name rdpvnc -v /home/zbttl/rdp_download:/root -p 3389:3389 -p 5901:5901 -p 6901:6901   soff/tiny-remote-desktop</span><br></pre></td></tr></tbody></table></figure>

<p>下载的文件会被放在 <code>/home/zbttl/rdp_download/Downloads</code>。但没有办法用非 root 方式运行，试过 <code>-u</code> 运行不起来，<code>-e</code> 没用。</p>
<p>如果要用密码连接的话：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name rdpvnc -v /home/zbttl/rdp_download:/root -p 5901:5901 -p 6901:6901 -e VNC_PASSWORD="vncpassword"  soff/tiny-remote-desktop</span><br></pre></td></tr></tbody></table></figure>

<p>但这样就不能开 rdp 了。</p>
<h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><h4 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h4><p>参考文章：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.zhihu.in/archives/261">内网穿透工具frp服务器端frps一键安装教程</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.zhihu.in/archives/2119">内网穿透工具frp Windows客户端frpc安装及使用教程</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.51cto.com/sonlich/2126175">利用vps+frp实现访问公司内网windows远程桌面</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.hi-linux.com/posts/25686.html">推荐一款很好用的内网穿透工具 FRP</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://diannaobos.com/post/405.html">创建windows计划任务使FRP开机启动</a></li>
</ul>
<p>最重要的用途是拿来穿透到主机上做远程控制，部分代替 teamviewer。</p>
<p>在服务器端使用一键脚本安装</p>
<h5 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h5><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://raw.githubusercontent.com/clangcn/onekey-install-shell/master/frps/install-frps.sh -O ./install-frps.sh</span><br><span class="line">chmod 700 ./install-frps.sh</span><br><span class="line">./install-frps.sh install</span><br></pre></td></tr></tbody></table></figure>

<p>   回车后，需要设置参数，有几个参数要注意：</p>
<p>第一第二个的 frp 通信端口和 dashboard 端口如果不是端口冲突的话建议默认，dashboard 密码自己设，要记牢；</p>
<p>后面三个需要修改，</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Please input frps vhost_http_port [1-65535](Default vhost_http_port: 80):</span><br><span class="line">#输入frp进行http穿透的http服务端口，按Enter键表示默认80，否则手动输入新端口，一般不建议默认80，防止和caddy/nginx冲突</span><br><span class="line"></span><br><span class="line">Please input frps vhost_https_port [1-65535](Default vhost_https_port: 443):</span><br><span class="line">#输入frp进行https穿透的https服务端口，按Enter键表示默认443，否则手动输入新端口,建议不用默认，防止和caddy/nginx冲突</span><br><span class="line"></span><br><span class="line">Please input privilege_token (Default: WEWLRgwRjIJVPx2kuqzkGnvuftPLQniq):</span><br><span class="line">#输入frp服务器和客户端通信的密码，默认是随机生成的，按Enter键表示按默认来，否则手动输入。frpc客户端需要这个接头暗号</span><br></pre></td></tr></tbody></table></figure>

<p>后面的基本全部设置为默认就行了，除了特殊情况：mux 打开后如果觉得卡顿断流需要关掉；kcp 如果恰逢家中宽带被运营商 qos 的话也建议关掉。</p>
<p>如果设置错误的话，可以使用 <code>frps config</code> 命令修改。</p>
<p>配置好后使用 <code>frps status</code>确认是否正确运行。</p>
<h5 id="客户端（windows）"><a href="#客户端（windows）" class="headerlink" title="客户端（windows）"></a>客户端（windows）</h5><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/fatedier/frp/releases">下载</a> windows 命令行客户端，解压到任意目录，并在解压目录下地址栏输入 cmd 进入命令行界面。</p>
<p>修改 frpc.ini（这里只配置了远程控制）</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = 167.179.x.x</span><br><span class="line">server_port = 5443        </span><br><span class="line">token=123456</span><br><span class="line">type = kcp</span><br><span class="line">[rdp]</span><br><span class="line">local_ip = 127.0.0.1           </span><br><span class="line">local_port = 3389                 </span><br><span class="line">remote_port = 5200              </span><br></pre></td></tr></tbody></table></figure>

<p>其中，server_addr 是服务器地址，sever_port 是 frp 通信端口，token 则是通信密码；rdp 中前三项不用改，第四项决定着你接下来要用的远程地址后跟端口号是多少。注意 ini 配置文件不能放注释。</p>
<p>然后在 cmd 下面敲入</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frpc -c frpc.ini</span><br></pre></td></tr></tbody></table></figure>

<p>如果出现下面界面证明启动成功</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/OJzLDBS.png"></p>
<p>此时使用 rdp 客户端访问 <code>ip:5200</code>即可远程访问该电脑。因为我们域名指向了该 ip，也可以用<code>域名:5200</code>访问该电脑。当然也可以通过 nginx/caddy 反向代理，无需域名，这里不再赘述。</p>
<p>此时使用<code>域名:6443</code>（dashboard 默认端口）就应该能够进入到 frp 的管理页面，可以看到 tcp 项里面远程桌面端口在线。</p>
<p>另外，如果发现某些时候重启后 frp.exe 并没有启动，可以到服务界面中将其自启模式改为「自动（延迟）」。</p>
<h5 id="快速运行"><a href="#快速运行" class="headerlink" title="快速运行"></a>快速运行</h5><p>新建一个 bat，假设 frp 文件夹放在 <code>E:\network tools\frp</code> 下</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off  </span><br><span class="line">start  "C:\Windows\System32\cmd.exe"   </span><br><span class="line">"E:\network tools\frp\frpc" -c "E:\network tools\frp\frpc.ini"</span><br><span class="line">exit</span><br></pre></td></tr></tbody></table></figure>

<p>双击打开，运行正常。</p>
<h5 id="配置自启"><a href="#配置自启" class="headerlink" title="配置自启"></a>配置自启</h5><p>建议配合 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kohsuke/winsw/releases">winsw</a> 实现自启。根据系统环境下载 net2 或 net4 版本的可执行文件，下载后放入 frp 文件夹中，改名为 winsw.exe。并在相同目录创建一个 winsw.xml，输入以下文字</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;service&gt;</span><br><span class="line"></span><br><span class="line">    &lt;id&gt;frp&lt;/id&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;frp&lt;/name&gt;</span><br><span class="line"></span><br><span class="line">    &lt;description&gt;用frp发布本地电脑网站到外网&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;executable&gt;frpc&lt;/executable&gt;</span><br><span class="line"></span><br><span class="line">    &lt;arguments&gt;-c frpc.ini&lt;/arguments&gt;</span><br><span class="line"></span><br><span class="line">    &lt;logmode&gt;reset&lt;/logmode&gt;</span><br><span class="line"></span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>然后 frp 文件夹地址栏敲入 cmd，输入<code>winsw install</code>，没有错误的话证明配置成功，输入<code>winsw start</code>立即启动。</p>
<p>另外，有可能还要到 services.msc 处将服务自启类型调为<code>自动(延迟)</code>，避免因为刚开机网络服务没有启动导致连接失败并无法自动重新启动。</p>
<h5 id="stcp-和-xtcp"><a href="#stcp-和-xtcp" class="headerlink" title="stcp 和 xtcp"></a>stcp 和 xtcp</h5><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/fatedier/frp/blob/master/README_zh.md">frp中文文档</a></p>
<p>虽然一个单词只差。。。但这俩区别很大，前者是将 tcp 进行加密，而后者是 nat 打孔，之后流量不经过 vps 而是服务端和客户端直连。</p>
<p>配置方法倒是差不多。</p>
<p>服务端需要加一个 udp 端口</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind_udp_port = 7001</span><br></pre></td></tr></tbody></table></figure>

<p>然后客户端，删去 common 内的 <code>protocol = kcp</code></p>
<p>加入一个节点</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[rdp-stcp]</span><br><span class="line">type = stcp</span><br><span class="line"># 只有 sk 一致的用户才能访问到此服务</span><br><span class="line">sk = abcdefg</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 3389</span><br></pre></td></tr></tbody></table></figure>

<p>另外，在另一段，连接过去的机子上也要做一个客户端，因为两边都有客户端了，就不需要 remote_port 了。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = x.x.x.x</span><br><span class="line">server_port = 5443</span><br><span class="line"></span><br><span class="line">[rdp-stcp-rdp-stcp]</span><br><span class="line">type = stcp</span><br><span class="line"># xtcp 的访问者</span><br><span class="line">role = visitor</span><br><span class="line"># 要访问的 xtcp 代理的名字</span><br><span class="line">server_name = p2p_ssh</span><br><span class="line">sk = abcdefg</span><br><span class="line"># 绑定本地端口用于访问 ssh 服务</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5200</span><br></pre></td></tr></tbody></table></figure>

<p>此时同样通过 ip:5200 连接。</p>
<p>使用 xtcp 的话，只要把上面的 stcp 改成 xtcp 就行。</p>
<p>不过，sftp 经过我实验没问题，xtcp 尽管我家已经调整为 fullcone nat 但还是连不上，挺见鬼。</p>
<h4 id="nps"><a href="#nps" class="headerlink" title="nps"></a>nps</h4><p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://ehang-io.github.io/nps/#/server_config">nps 配置</a></p>
<p>frp 有个大问题，就是安全性。开了 frp 结果发现电脑日志中一大堆扫描的痕迹，毕竟有了 ip 和端口就可以无限扫描这个开在公网的电脑。。。</p>
<p>虽然有 xftp 这玩意，但 xftp 在手机上其实不太好使用（要用 termux 之类的终端模拟器运行 frpc）。其他的方案，就是使用 nps。</p>
<h5 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h5><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ehang-io/nps/releases">下载地址</a>，下载后解压修改 <code>conf</code> 文件夹下的 <code>nps.conf</code>。参考配置</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">appname = nps</span><br><span class="line">#Boot mode(dev|pro)</span><br><span class="line">runmode = dev</span><br><span class="line"></span><br><span class="line">#HTTP(S) proxy port, no startup if empty</span><br><span class="line">http_proxy_ip=0.0.0.0</span><br><span class="line">http_proxy_port=10002</span><br><span class="line">https_proxy_port=10003</span><br><span class="line">https_just_proxy=true</span><br><span class="line">#default https certificate setting</span><br><span class="line">https_default_cert_file=conf/server.pem</span><br><span class="line">https_default_key_file=conf/server.key</span><br><span class="line"></span><br><span class="line">##bridge</span><br><span class="line">bridge_type=tcp</span><br><span class="line">bridge_port=8024</span><br><span class="line">bridge_ip=0.0.0.0</span><br><span class="line"></span><br><span class="line"># Public password, which clients can use to connect to the server</span><br><span class="line"># After the connection, the server will be able to open relevant ports and parse related domain names according to its own configuration file.</span><br><span class="line">public_vkey=123</span><br><span class="line"></span><br><span class="line">#Traffic data persistence interval(minute)</span><br><span class="line">#Ignorance means no persistence</span><br><span class="line">#flow_store_interval=1</span><br><span class="line"></span><br><span class="line"># log level LevelEmergency-&gt;0  LevelAlert-&gt;1 LevelCritical-&gt;2 LevelError-&gt;3 LevelWarning-&gt;4 LevelNotice-&gt;5 LevelInformational-&gt;6 LevelDebug-&gt;7</span><br><span class="line">log_level=7</span><br><span class="line">#log_path=nps.log</span><br><span class="line"></span><br><span class="line">#Whether to restrict IP access, true or false or ignore</span><br><span class="line">#ip_limit=true</span><br><span class="line"></span><br><span class="line">#p2p</span><br><span class="line">#p2p_ip=127.0.0.1</span><br><span class="line">#p2p_port=6000</span><br><span class="line"></span><br><span class="line">#web</span><br><span class="line">web_host=a.o.com</span><br><span class="line">web_username=[账号]</span><br><span class="line">web_password=[密码]</span><br><span class="line">web_port = [端口]</span><br><span class="line">web_ip=0.0.0.0</span><br><span class="line">web_base_url=</span><br><span class="line">web_open_ssl=false</span><br><span class="line">web_cert_file=conf/server.pem</span><br><span class="line">web_key_file=conf/server.key</span><br><span class="line"># if web under proxy use sub path. like http://host/nps need this.</span><br><span class="line">#web_base_url=/nps</span><br><span class="line"></span><br><span class="line">#Web API unauthenticated IP address(the len of auth_crypt_key must be 16)</span><br><span class="line">#Remove comments if needed</span><br><span class="line">#auth_key=test</span><br><span class="line">auth_crypt_key =1234567812345678</span><br><span class="line"></span><br><span class="line">#allow_ports=9001-9009,10001,11000-12000</span><br><span class="line"></span><br><span class="line">#Web management multi-user login</span><br><span class="line">allow_user_login=false</span><br><span class="line">allow_user_register=false</span><br><span class="line">allow_user_change_username=false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#extension</span><br><span class="line">allow_flow_limit=false</span><br><span class="line">allow_rate_limit=false</span><br><span class="line">allow_tunnel_num_limit=false</span><br><span class="line">allow_local_proxy=false</span><br><span class="line">allow_connection_num_limit=false</span><br><span class="line">allow_multi_ip=false</span><br><span class="line">system_info_display=false</span><br><span class="line"></span><br><span class="line">#cache</span><br><span class="line">http_cache=false</span><br><span class="line">http_cache_length=100</span><br><span class="line"></span><br><span class="line">#get origin ip</span><br><span class="line">http_add_origin_header=false</span><br><span class="line"></span><br><span class="line">#pprof debug options</span><br><span class="line">#pprof_ip=0.0.0.0</span><br><span class="line">#pprof_port=9999</span><br><span class="line"></span><br><span class="line">#client disconnect timeout</span><br><span class="line">disconnect_timeout=60</span><br></pre></td></tr></tbody></table></figure>

<p>主要修改 <code>web_username</code>、<code>web_password</code> 和 <code>web_port</code>，以及 <code>http_proxy_port</code> 和 <code>https_proxy_port</code> 端口不可以重复。然后直接运行</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nps</span><br></pre></td></tr></tbody></table></figure>

<p>或者安装后运行</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./nps install</span><br><span class="line">nps start</span><br></pre></td></tr></tbody></table></figure>

<p>前者在前台运行，有日志。后者安装时会把刚刚修改好的 <code>nps.conf</code> 考到 <code>/etc/nps.conf</code> 中，到时有要改的修改那个就好。</p>
<p>然后在浏览器中打开 <code>[vps ip]:web_port</code>，输入上面我说要主要修改的账户和密码。</p>
<p>到客户端处点击加号新增配置</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/7l7REb9.png"></p>
<p>basic 那两项可以不填，但为了安全最好填上，这两项是 socks 的账户和密码（一般 socks 代理我们都是用在本地 v2ray/ss 和浏览器之间的链接，一般都不设密码。现在是和远程服务器链接，所以需要密码保护安全）</p>
<p>验证密钥记清楚。待会客户端要用到。</p>
<p>保存后列表中会显示刚刚我们新增配置的 id，也记住。</p>
<p>切换到 socks 代理，新增一个配置，填入上一句我说要记住的的配置 id，端口任填一个，也记住，待会也是客户端用到。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/mYBY1qN.png"></p>
<h5 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h5><p>在上面的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ehang-io/nps/releases">下载地址</a>中下载客户端。解压后修改 <code>conf/npc.conf</code>，将大部分配置删除（不要注释，注释没用，照样报错），留下下面这些</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr=[vps ip]:8024</span><br><span class="line">conn_type=tcp</span><br><span class="line">vkey=[验证密钥]</span><br><span class="line">auto_reconnection=true</span><br><span class="line">max_conn=1000</span><br><span class="line">flow_limit=1000</span><br><span class="line">rate_limit=1000</span><br><span class="line">basic_username=[也许可以不填，填的话填上面那个basic的账户]</span><br><span class="line">basic_password=[也许可以不填，填的话填上面那个basic的密码]</span><br><span class="line">crypt=true</span><br><span class="line">compress=true</span><br><span class="line">#pprof_addr=0.0.0.0:9999</span><br><span class="line">disconnect_timeout=60</span><br></pre></td></tr></tbody></table></figure>

<p>运行 <code>./npc</code> 启动。如果成功的话会显示如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zbpicture/picture@main/img/WzbpA9R.png"></p>
<p>手机这边，用有 socks 代理的工具，比如 v2ray。ip 填 vps ip，端口填服务端时填的端口。账户和密码是服务端的 <code>basic_username</code> 和 <code>basic_password</code>。连接后，不需要像 frp 一样填 vps 的 ip 和穿透使用的另一个端口，而是用原来在内网连接的 ip 和端口即可。另外，只要在内网任意一台设备中开启一个客户端，内网中的所有设备和服务都可以透穿 —— 比如在虚拟机中开启了客户端，在 rdp 中输入局域网中虚拟机原机子的 ip 照样可以链接（虽然我又感觉有点不太安全了）。</p>
<h3 id="网盘类"><a href="#网盘类" class="headerlink" title="网盘类"></a>网盘类</h3><h4 id="cloudreve（选做）"><a href="#cloudreve（选做）" class="headerlink" title="cloudreve（选做）"></a>cloudreve（选做）</h4><p>参考文章：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.senra.me/build-your-own-cloud-storage-series-cloudreve-another-production-of-shudong-share-author/">自建云盘系列——Cloudreve(树洞外链作者的又一力作)</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://cvps.top/8189.html">【自建网盘】宝塔面板 安装Cloudreve 网盘系统 与 初缘cvps小站遇到的问题解决方案 （无响应）</a></li>
</ul>
<p>用这玩意的话，aria2 前端面板就不用搭了，另外还附赠一些其他服务器的外挂和中转功能可以用来扩充 vps 本身不大的硬盘（不过我手上的 onedrive 只能拿来中转，其实没什么用，无法下载比 ssd 硬盘最大容量还大的资源），另外其本身也是一个 filemanager，不过嘛。。。只能管理站内内容，站外文件夹摸不到，所以其实没什么用（能管理站外内容的话就可以和上面几个工具联合管理一个文件夹了）。主要是搭建上其实很麻烦。。。</p>
<ol>
<li><p>有两种安装方法，一种是靠 composer 进行快速部署，另一种是直接下载压缩包然后释放到网站文件夹里面，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/HFO4/Cloudreve/wiki/%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E">官方github</a>给的安装方法是用前者。但我试过 composer 的方法，有些功能会出错（比如 cron 进程守护，还有图片集功能），所以还是建议直接用下载压缩包的方法进行部署。先进<code>https://cloudreve.org/download.php</code>，下载安装包后传到 vps 的 <code>/root</code>下，然后解压到站点。</p>
<p>先新建一个站点，lnmp 一键包新建的时候注意这个站点的 rewrite 规则需要配置，使用thinkphp，宝塔可以建了再设置。假设我的站点位于<code>/home/cloudreve</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip xxxx.zip -d /home/Cloudreve/</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>然后进入站点目录</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /home/Cloudreve/</span><br></pre></td></tr></tbody></table></figure>

<p>设置权限（文件夹用户必须是 www 否则打不开，runtime 和 public 不开写入权限就下不了东西），宝塔在站点根目录那里点一下，就可以进到 ui 界面里面调了</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R www:www *</span><br><span class="line">chmod -R 755 runtime public</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>之后导入目录里面的 mysql.sql 文件，需要先创建一个数据库，建议先新建一个叫 Cloudreve 的用户来创建数据库</p>
<p>然后导入</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u zbttl -p Cloudreve &lt; /home/Cloudreve/mysql.sql</span><br></pre></td></tr></tbody></table></figure>

<p>输入密码即可导入成功。如果是宝塔面板，从 ui 界面新建数据库，然后按下管理，将 mysql.php 下到本地再拖到网页中即可自动导入。</p>
</li>
<li><p>编辑 <code>/home/Cloudreve/application/database_sample.php</code> 文件</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /home/Cloudreve/application/database_sample.php</span><br></pre></td></tr></tbody></table></figure>

<p>更改数据名，用户名和密码。然后更改名字为 <code>database.php</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ./database_sample.php ./database.php</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>最后访问站点，初始用户名：<code>admin@cloudreve.org</code>，初始密码：<code>admin</code>，后台URl：<code>http://你的域名/Admin</code>，即可使用。输入<code>你的域名/Cron</code>，若是显示几行代码，说明自启可配置</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/crontab</span><br><span class="line">#或者是 nano /var/spool/cron/root</span><br></pre></td></tr></tbody></table></figure>

<p>在最后一行输入</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * curl http://你的域名/Cron</span><br></pre></td></tr></tbody></table></figure>

<p>如果是宝塔面板，在计划任务处添加任务即可。</p>
</li>
<li><p>另外注意几个坑：</p>
<ol>
<li>进去记得改帐号和密码</li>
<li>要离线下载需要先装 aria2 后端，前端 AriaNG 可以不装了。而且默认的目录也是错的，需要你自己去改。另外就算是管理员，一开始也只有 1g 空间也不能够离线下载，需要在后端增大空间，开放离线下载权限。</li>
</ol>
</li>
</ol>
<h4 id="rclone"><a href="#rclone" class="headerlink" title="rclone"></a>rclone</h4><p>参考文章：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://p3terx.com/archives/rclone-installation-and-configuration-tutorial.html">Rclone 安装配置教程 - 连接 OneDrive 和 Google Drive</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://p3terx.com/archives/linux-vps-uses-rclone-to-mount-network-drives-such-as-onedrive-and-google-drive.html">Rclone 使用教程 - 挂载 OneDrive、Google Drive 等网盘(Linux)</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://p3terx.com/archives/rclone-advanced-user-manual-common-command-parameters.html">Rclone 进阶使用教程 - 常用命令参数详解</a></li>
</ul>
<p>详细过程不谈，这三篇文章讲的相对清楚了。</p>
<p>先按第一篇文章的方法在 windows 上获取一长串密钥通过密钥在 linux 上完成链接。</p>
<p>然后第二篇重点讲的是 rclone mount。</p>
<p>第三篇讲的是 rclone 的其他指令，比如 rclone copy，rclone move。</p>
<p>有一些小贴士：</p>
<ol>
<li><p>rclone mount 需要事先安装 fuse，往 mount 网盘的文件夹使用 copy、move 等指令其实和 rclone copy、move 的效果（起码速度是）差不多，不过 rclone 类指令可以在后台运行，后台运行时也可以通过 <code>-v</code> 参数获取当前速度和最后所用时间，比单纯的 copy 好用一些但指令也复杂。</p>
</li>
<li><p>不过使用 rclone move 要注意，文件是搬过去了，但是搬移的文件夹里面的子文件夹并不会自动删除，需要多带一个参数 <code>--delete-empty-src-dirs</code>。-v 是显示进度，嫌显示的不够多可以换成 -vv。默认 4 线程，经常断，可能是内存原因，保险一点，单线程，虽然慢，不会断。最后出来的参数类似：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone copy -v /home/zbttl/aria2 zbttltest:pan --transfers=1 --delete-empty-src-dirs</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>不知道自己网盘里有啥？</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone lsd [网盘名称]:/</span><br></pre></td></tr></tbody></table></figure>

<p>不知道自己网盘设置为啥名字了？</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone config</span><br></pre></td></tr></tbody></table></figure>

<p>久不用了可能还要重新获取 token，用上面这个命令，选择 edit 响应的网盘，先是提示是否更改 client_id 和 client_secret，选择否（自建 api 的话才需要检查和修改），然后会弹出一次提示，选择「That’s OK」；然后就会提示「Already have a token - refresh?」，重新获取粘贴就好。</p>
</li>
<li><p>尽管挂载了，用 filebrowser 开进去看挂载网盘的文件夹还是空的；下载工具下载地址直接指向挂载文件夹会报错，因为缓存没那么大。还是老老实实下到其他地方再用命令转过去，或者用自动调用 rclone 的下载工具吧。</p>
</li>
<li><p>另外，想加速的话，还能通过<a target="_blank" rel="external nofollow noopener noreferrer" href="https://p3terx.com/archives/rclone-connect-onedrive-with-selfbuilt-api.html">Rclone 使用自建 API 连接 OneDrive（Office 365 E5 自动续订）</a>自建 api 加速（虽然我实验了感觉效果不太好，也有可能是我之前用的是共用接口，后来改用私有接口的时候配置没更新好，总之我不太想再折腾了），以及加缓存（<code>--onedrive-chunk-size</code>，大部分加 100m 也就是 102400，但吃内存太大容易被杀）和加线程（<code>--transfers</code>，建议为 4 不稳定）。</p>
</li>
<li><p>copy 到 onedrive 的中文文件夹，需要给文件夹打单引号，比如 `zbttl:’下载文件集合’。</p>
</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>zbttl
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://zbttl-github-io.vercel.app/yi-bu-dao-wei-de-vps-cong-ru-men-dao-fang-qi/" title="一步到位的 vps 从入门到放弃">https://zbttl-github-io.vercel.app/yi-bu-dao-wei-de-vps-cong-ru-men-dao-fang-qi/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
        <a target="_blank" class="social-link" href="/atom.xml">
          <span class="icon">
            <i class="fa fa-rss"></i>
          </span>

          <span class="label">RSS</span>
        </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
              <a href="/tags/rdp/" rel="tag"># rdp</a>
              <a href="/tags/lnmp/" rel="tag"># lnmp</a>
              <a href="/tags/nginx/" rel="tag"># nginx</a>
              <a href="/tags/docker/" rel="tag"># docker</a>
              <a href="/tags/rsshub/" rel="tag"># rsshub</a>
              <a href="/tags/filemanger/" rel="tag"># filemanger</a>
              <a href="/tags/aria2/" rel="tag"># aria2</a>
              <a href="/tags/transmission/" rel="tag"># transmission</a>
              <a href="/tags/bt/" rel="tag"># bt</a>
              <a href="/tags/vscoder/" rel="tag"># vscoder</a>
              <a href="/tags/emule/" rel="tag"># emule</a>
              <a href="/tags/vnc/" rel="tag"># vnc</a>
              <a href="/tags/frp/" rel="tag"># frp</a>
              <a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" rel="tag"># 内网穿透</a>
              <a href="/tags/cloudreve/" rel="tag"># cloudreve</a>
              <a href="/tags/rclone/" rel="tag"># rclone</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/ge-ping-tai-zi-ti-mei-hua-zhi-nan/" rel="prev" title="各平台字体美化指南">
                  <i class="fa fa-chevron-left"></i> 各平台字体美化指南
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/powershell-quan-gong-lue/" rel="next" title="powershell 全攻略">
                  powershell 全攻略 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zbttl</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">336k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">10:11</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">本博客使用 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a> 
  </div><script color="120,120,120" opacity="0.5" zindex="-1" count="150" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>
<!--《添加网站运行时间 -->
<!--<br/>-->
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();

    function createtime() {
        var grt = new Date("12/18/2020 12:00:00"); //此处修改你的建站时间或者网站上线时间 
        now.setTime(now.getTime() + 250);
        days = (now - grt) / 1000 / 60 / 60 / 24;
        dnum = Math.floor(days);
        hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
        hnum = Math.floor(hours);
        if (String(hnum).length == 1) {
            hnum = "0" + hnum;
        }
        minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes);
        if (String(mnum).length == 1) {
            mnum = "0" + mnum;
        }
        seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds);
        if (String(snum).length == 1) {
            snum = "0" + snum;
        }
        document.getElementById("timeDate").innerHTML = " 本站已安全运行 " + dnum + " 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
    setInterval("createtime()", 250);
</script>
<!-- 添加网站运行时间》 -->

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : 28813,
      el    : 'wpac-rating',
      color : '#fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.css">

<script>
NexT.utils.loadComments('#gitalk-container', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'd99d750bdfdb31ecf37e',
      clientSecret: '1d37215aff71dc84b66e03cb412c7e68b968d76f',
      repo        : 'zbttl-comment',
      owner       : 'zbpicture',
      admin       : ['zbpicture'],
      id          : '3a1dc525742737bdd0a3791de988886c',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

<script type="text/javascript" src=" https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script async src="/js/cursor/text.js"></script>




</body>
</html>
